<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºˆç´„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LIFF SDK -->
    <script src="https://liff.line.me/sdk/web/liff.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FACC15',
                        'primary-hover': '#EAB308',
                        text: '#000000',
                        bg: '#FFFFFF',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; }
        .screen { display: none; }
        .screen.active { display: block; }
        input, select, textarea { font-size: 1.125rem; }
    </style>
</head>
<body class="bg-gray-100 text-black antialiased lg:bg-white">

    <!-- ã‚¹ãƒãƒ›ã¯ä¸­å¤®é…ç½®ã€PCã¯å…¨å¹…è¡¨ç¤º -->
    <div class="max-w-md mx-auto lg:max-w-none lg:mx-0 bg-white min-h-screen shadow-lg lg:shadow-none relative pb-10 lg:pb-16">
        
        <header class="bg-primary p-4 lg:p-6 text-center font-bold text-xl lg:text-3xl shadow-sm sticky top-0 z-10">
            ãƒã‚¹ãƒ„ã‚¢ãƒ¼äºˆç´„
        </header>

        <div id="screen-b01" class="screen active p-4 lg:px-20 lg:py-10">
            <div class="lg:max-w-4xl lg:mx-auto">
                <div class="flex items-center justify-between mb-6 lg:mb-10">
                    <button onclick="changeMonth(-1)" class="text-blue-600 font-bold text-2xl lg:text-4xl px-4 py-2 lg:px-6 lg:py-3 hover:bg-gray-100 rounded-lg">&lt;</button>
                    <h2 class="text-xl lg:text-3xl font-bold" id="calendar-month-title">--å¹´--æœˆ</h2>
                    <button onclick="changeMonth(1)" class="text-blue-600 font-bold text-2xl lg:text-4xl px-4 py-2 lg:px-6 lg:py-3 hover:bg-gray-100 rounded-lg">&gt;</button>
                </div>
                <div class="grid grid-cols-7 gap-2 lg:gap-4 text-center mb-2 lg:mb-4 font-bold text-gray-600 lg:text-xl">
                    <div>æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div>åœŸ</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2 lg:gap-4 text-center">
                <div class="h-14 flex items-center justify-center text-gray-400">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            <p class="mt-6 lg:mt-10 text-sm lg:text-lg text-gray-500 text-center">â€»ã‚°ãƒ¬ãƒ¼ã®æ—¥ä»˜ã¯é¸æŠã§ãã¾ã›ã‚“</p>
            </div>
        </div>

        <div id="screen-b02" class="screen p-4 lg:px-20 lg:py-10">
            <div class="lg:max-w-4xl lg:mx-auto">
                <button onclick="goTo('screen-b01')" class="text-blue-600 mb-4 lg:mb-6 text-lg lg:text-2xl font-bold">&lt; æ—¥ä»˜ã‚’å¤‰æ›´</button>
                <h2 class="text-xl lg:text-3xl font-bold mb-4 lg:mb-8" id="view-date-title">--æœˆ--æ—¥ã®ãƒ„ã‚¢ãƒ¼</h2>
                <div id="tour-list" class="space-y-6 lg:space-y-8">
                <div class="text-center text-gray-400 py-8">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            </div>
        </div>

        <div id="screen-b03" class="screen p-4 lg:px-20 lg:py-10">
            <div class="lg:max-w-2xl lg:mx-auto">
                <button onclick="goTo('screen-b02')" class="text-blue-600 mb-4 lg:mb-6 text-lg lg:text-2xl font-bold">&lt; æˆ»ã‚‹</button>
                <h2 class="text-2xl lg:text-3xl font-bold mb-6 lg:mb-10">ãŠå®¢æ§˜æƒ…å ±ã®å…¥åŠ›</h2>
                <form id="booking-form" onsubmit="event.preventDefault(); submitUserInfo();">
                    <div class="mb-6 lg:mb-8">
                        <label class="block text-lg lg:text-2xl font-bold mb-2 lg:mb-3">ãŠåå‰ <span class="text-red-500">*</span></label>
                        <input type="text" id="input-name" class="w-full border-2 border-gray-300 p-3 lg:p-4 rounded-lg bg-gray-50 lg:text-xl" required>
                    </div>
                    <div class="mb-6 lg:mb-8">
                        <label class="block text-lg lg:text-2xl font-bold mb-2 lg:mb-3">é›»è©±ç•ªå· <span class="text-red-500">*</span></label>
                        <input type="tel" id="input-phone" class="w-full border-2 border-gray-300 p-3 lg:p-4 rounded-lg bg-gray-50 lg:text-xl" required>
                    </div>
                <div class="mb-6 p-4 bg-gray-50 rounded-xl border border-gray-200">
                    <p class="font-bold text-lg mb-4 border-b pb-2">ã”ä½æ‰€ <span class="text-red-500">*</span></p>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1 text-gray-600">éƒµä¾¿ç•ªå·</label>
                        <input type="text" id="input-zip" class="w-full border-2 border-gray-300 p-3 rounded-lg bg-white">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1 text-gray-600">éƒ½é“åºœçœŒ</label>
                        <select id="input-pref" class="w-full border-2 border-gray-300 p-3 rounded-lg bg-white h-14">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="æ±äº¬éƒ½">æ±äº¬éƒ½</option>
                            <option value="ç¥å¥ˆå·çœŒ">ç¥å¥ˆå·çœŒ</option>
                            <option value="åŸ¼ç‰çœŒ">åŸ¼ç‰çœŒ</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1 text-gray-600">å¸‚åŒºç”ºæ‘</label>
                        <input type="text" id="input-city" class="w-full border-2 border-gray-300 p-3 rounded-lg bg-white">
                    </div>
                    <div class="mb-0">
                        <label class="block text-sm font-bold mb-1 text-gray-600">ç•ªåœ°ãƒ»å»ºç‰©å</label>
                        <input type="text" id="input-street" class="w-full border-2 border-gray-300 p-3 rounded-lg bg-white">
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-lg font-bold mb-2">å‚åŠ äººæ•°</label>
                    <select id="input-passengers" class="w-full border-2 border-gray-300 p-3 rounded-lg bg-white text-lg">
                        <option value="1">1å</option>
                        <option value="2">2å</option>
                        <option value="3">3å</option>
                        <option value="4">4å</option>
                    </select>
                </div>
                <div class="mb-6" id="preferred-seats-area"></div>
                <div class="mb-8 flex items-center bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                    <input type="checkbox" id="consent-next" class="w-6 h-6 text-primary border-gray-300 rounded focus:ring-primary">
                    <label for="consent-next" class="ml-3 text-lg font-bold">æ¬¡å›ã‚‚ã“ã®æƒ…å ±ã‚’ä½¿ã†</label>
                </div>
                <button type="submit" class="w-full bg-primary hover:bg-primary-hover text-black font-bold py-4 rounded-xl text-xl shadow-md border-b-4 border-yellow-500 active:border-b-0 active:translate-y-1">
                    æ¬¡ã¸é€²ã‚€
                </button>
                </form>
            </div>
        </div>

        <div id="screen-b04" class="screen p-4 lg:px-20 lg:py-10">
            <div class="lg:max-w-2xl lg:mx-auto">
                <button onclick="goTo('screen-b03')" class="text-blue-600 mb-4 lg:mb-6 text-lg lg:text-2xl font-bold">&lt; æˆ»ã‚‹</button>
                <h2 class="text-2xl lg:text-3xl font-bold mb-6 lg:mb-10">ä¹—è»Šå ´æ‰€ã®é¸æŠ</h2>
                <p class="mb-4 lg:mb-6 font-bold text-lg lg:text-2xl" id="pickup-count-label">å‚åŠ äººæ•°ï¼š--å</p>
            <div id="pickup-mode-selector" class="hidden mb-6 flex-col gap-4">
                <label class="flex items-center p-4 border rounded-lg bg-white cursor-pointer has-[:checked]:border-primary has-[:checked]:bg-yellow-50 transition">
                    <input type="radio" name="pickup_mode" value="same" class="w-6 h-6" checked onchange="renderPickupDropdowns()">
                    <span class="ml-3 text-lg font-bold">å…¨å“¡åŒã˜å ´æ‰€ã‹ã‚‰ä¹—è»Š</span>
                </label>
                <label class="flex items-center p-4 border rounded-lg bg-white cursor-pointer has-[:checked]:border-primary has-[:checked]:bg-yellow-50 transition">
                    <input type="radio" name="pickup_mode" value="individual" class="w-6 h-6" onchange="renderPickupDropdowns()">
                    <span class="ml-3 text-lg font-bold">ä¸€äººãšã¤é¸ã¶</span>
                </label>
            </div>
            <div id="pickup-dropdowns-area" class="space-y-4 lg:space-y-6 mb-8 lg:mb-12"></div>
            <button onclick="submitPickups()" class="w-full bg-primary hover:bg-primary-hover text-black font-bold py-4 lg:py-5 rounded-xl text-xl lg:text-2xl shadow-md border-b-4 border-yellow-500 active:border-b-0 active:translate-y-1 transition-colors">
                ç¢ºèªç”»é¢ã¸
            </button>
            </div>
        </div>

        <div id="screen-b05" class="screen p-4 lg:px-20 lg:py-10">
            <div class="lg:max-w-2xl lg:mx-auto">
                <button onclick="goTo('screen-b04')" class="text-blue-600 mb-4 lg:mb-6 text-lg lg:text-2xl font-bold">&lt; æˆ»ã‚‹</button>
                <h2 class="text-2xl lg:text-3xl font-bold mb-6 lg:mb-10">äºˆç´„å†…å®¹ã®ç¢ºèª</h2>
            <div class="bg-gray-50 p-6 lg:p-8 rounded-xl border border-gray-200 mb-8 lg:mb-12">
                <div class="mb-4 lg:mb-6 pb-4 lg:pb-6 border-b border-gray-300">
                    <p class="text-gray-600 text-sm lg:text-lg">ãƒ„ã‚¢ãƒ¼å</p>
                    <p class="text-xl lg:text-2xl font-bold" id="conf-tour">--</p>
                </div>
                <div class="mb-4 lg:mb-6 pb-4 lg:pb-6 border-b border-gray-300">
                    <p class="text-gray-600 text-sm lg:text-lg">æ—¥ä»˜</p>
                    <p class="text-xl lg:text-2xl font-bold" id="conf-date">--</p>
                </div>
                <div class="mb-4 lg:mb-6 pb-4 lg:pb-6 border-b border-gray-300">
                    <p class="text-gray-600 text-sm lg:text-lg">ä»£è¡¨è€…å</p>
                    <p class="text-xl lg:text-2xl font-bold" id="conf-name">-- æ§˜</p>
                </div>
                <div class="mb-4 lg:mb-6 pb-4 lg:pb-6 border-b border-gray-300">
                    <p class="text-gray-600 text-sm lg:text-lg">äººæ•°</p>
                    <p class="text-xl lg:text-2xl font-bold" id="conf-passengers">--å</p>
                </div>
                <div class="mb-4 lg:mb-6 pb-4 lg:pb-6 border-b border-gray-300">
                    <p class="text-gray-600 text-sm lg:text-lg">ä¹—è»Šå ´æ‰€</p>
                    <div id="conf-pickups" class="font-bold text-lg lg:text-2xl"></div>
                </div>
                <div class="mb-4 lg:mb-6 pb-4 lg:pb-6 border-b border-gray-300">
                    <p class="text-gray-600 text-sm lg:text-lg">å‰åˆ—åº§å¸­æŒ‡å®š</p>
                    <div id="conf-seats" class="font-bold text-lg lg:text-2xl"></div>
                </div>
                <div class="mt-6 lg:mt-8 space-y-2 lg:space-y-3">
                    <div class="flex justify-between text-sm lg:text-xl">
                        <span class="text-gray-600">åŸºæœ¬æ–™é‡‘</span>
                        <span class="font-bold" id="conf-base-price">Â¥0</span>
                    </div>
                    <div class="flex justify-between text-sm lg:text-xl">
                        <span class="text-gray-600">åº§å¸­æŒ‡å®šæ–™</span>
                        <span class="font-bold" id="conf-seat-price">Â¥0</span>
                    </div>
                    <div class="flex justify-between items-center mt-4 lg:mt-6 pt-4 lg:pt-6 border-t border-gray-300">
                        <span class="text-lg lg:text-2xl font-bold">åˆè¨ˆé‡‘é¡</span>
                        <span class="text-3xl lg:text-4xl font-bold text-red-600" id="conf-total">Â¥0</span>
                    </div>
                </div>
            </div>
            <button id="btn-confirm-reservation" onclick="submitReservation()" class="w-full bg-primary hover:bg-primary-hover text-black font-bold py-4 lg:py-6 rounded-xl text-2xl lg:text-3xl shadow-lg border-b-4 border-yellow-500 active:border-b-0 active:translate-y-1 transition-colors">
                äºˆç´„ã‚’ç¢ºå®šã™ã‚‹
            </button>
            </div>
        </div>

    </div>

    <script>
        const BOOKING_API_BASE = "https://your-backend-booking-url/api/booking";
        const PREFERRED_SEAT_PRICE = 500;

        let PICKUP_OPTIONS = [];
        let calendarData = {};
        let toursData = {};

        const cache = {
            lineUserId: null,
            date: null,
            tourId: null,
            tourTitle: null,
            pricePerPerson: 0,
            userInfo: {},
            passengers: 1,
            pickups: [],
            preferredSeats: [],
            isSubmitting: false
        };

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºç”¨ã®å¹´æœˆç®¡ç†
        let currentCalendarYear = new Date().getFullYear();
        let currentCalendarMonth = new Date().getMonth();

        document.addEventListener('DOMContentLoaded', async () => {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById('screen-b01').classList.add('active');
            
            try {
                const liffId = "YOUR_LIFF_ID";
                await liff.init({ liffId });
                
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    cache.lineUserId = profile.userId;
                    console.log("LIFF initialized:", cache.lineUserId);
                    await loadUserProfile();
                } else {
                    liff.login();
                }
            } catch (err) {
                console.error("LIFF init error:", err);
            }
            
            await Promise.all([
                loadCalendarData(),
                loadPickupOptions()
            ]);
        });

        async function loadCalendarData() {
            try {
                const response = await fetch(`${BOOKING_API_BASE}/calendar`);
                if (response.ok) {
                    const data = await response.json();
                    calendarData = {};
                    (data.dates || []).forEach(d => {
                        calendarData[d] = true;
                    });
                    renderCalendar();
                }
            } catch (err) {
                console.error("Failed to load calendar:", err);
            }
        }

        async function loadToursForDate(dateStr) {
            try {
                const response = await fetch(`${BOOKING_API_BASE}/tours?date=${dateStr}`);
                if (response.ok) {
                    const tours = await response.json();
                    toursData = {};
                    tours.forEach(t => {
                        toursData[t.id] = t;
                    });
                    renderTourList(dateStr);
                }
            } catch (err) {
                console.error("Failed to load tours:", err);
            }
        }

        async function loadPickupOptions() {
            try {
                const response = await fetch(`${BOOKING_API_BASE}/pickups`);
                if (response.ok) {
                    const pickups = await response.json();
                    PICKUP_OPTIONS = pickups.map(p => p.name);
                }
            } catch (err) {
                console.error("Failed to load pickups:", err);
                PICKUP_OPTIONS = ["æ–°å®¿é§… è¥¿å£", "æ±äº¬é§… ä¸¸ã®å†…åŒ—å£", "æ¨ªæµœé§… æ±å£"];
            }
        }

        async function loadUserProfile() {
            if (!cache.lineUserId) return;
            try {
                const response = await fetch(`${BOOKING_API_BASE}/profile?lineUserId=${cache.lineUserId}`);
                if (response.ok) {
                    const profile = await response.json();
                    if (profile && Object.keys(profile).length > 0) {
                        localStorage.setItem('user_profile_cache', JSON.stringify(profile));
                    }
                }
            } catch (err) {
                console.error("Failed to load profile:", err);
            }
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            const year = currentCalendarYear;
            const month = currentCalendarMonth;
            
            document.getElementById('calendar-month-title').innerText = `${year}å¹´ ${month + 1}æœˆ`;
            
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            
            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'h-14 lg:h-20';
                grid.appendChild(empty);
            }
            
            for (let d = 1; d <= lastDate; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const isAvailable = calendarData[dateStr];
                
                if (isAvailable) {
                    const btn = document.createElement('button');
                    btn.className = 'h-14 lg:h-20 bg-white border-2 lg:border-3 border-primary text-black font-bold flex items-center justify-center rounded lg:rounded-lg shadow-sm hover:bg-yellow-50 lg:text-2xl transition-colors';
                    btn.innerText = d;
                    btn.onclick = () => selectDate(dateStr);
                    grid.appendChild(btn);
                } else {
                    const div = document.createElement('div');
                    div.className = 'h-14 lg:h-20 bg-gray-100 text-gray-400 flex items-center justify-center rounded lg:rounded-lg lg:text-2xl';
                    div.innerText = d;
                    grid.appendChild(div);
                }
            }
        }

        function changeMonth(delta) {
            currentCalendarMonth += delta;
            if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            } else if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            }
            renderCalendar();
        }

        function renderTourList(dateStr) {
            const container = document.getElementById('tour-list');
            container.innerHTML = '';
            
            const tours = Object.values(toursData);
            
            if (tours.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">ã“ã®æ—¥ã®ãƒ„ã‚¢ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            tours.forEach(tour => {
                const card = document.createElement('div');
                card.className = 'border rounded-xl overflow-hidden shadow-md lg:shadow-lg';
                
                const isFull = tour.remainingSeats <= 0 || tour.status === 'full';
                const statusBadge = isFull 
                    ? '<span class="absolute top-2 right-2 lg:top-4 lg:right-4 bg-red-500 text-white px-2 py-1 lg:px-4 lg:py-2 rounded text-sm lg:text-lg font-bold">æº€å¸­</span>' 
                    : '';
                
                const escapedTitle = tour.title.replace(/'/g, "\\'");
                
                card.innerHTML = `
                    <div class="relative">
                        ${tour.imageUrl 
                            ? `<img src="${tour.imageUrl}" alt="${tour.title}" class="w-full h-48 lg:h-64 object-cover">` 
                            : '<div class="bg-gray-300 h-48 lg:h-64 w-full flex items-center justify-center text-gray-500 font-bold lg:text-xl">ãƒ„ã‚¢ãƒ¼ç”»åƒ</div>'}
                        ${statusBadge}
                    </div>
                    <div class="p-4 lg:p-6">
                        <h3 class="text-xl lg:text-2xl font-bold mb-2 lg:mb-3">${tour.title}</h3>
                        <p class="text-gray-700 mb-2 lg:mb-3 text-lg lg:text-xl">${tour.description || ''}</p>
                        <p class="text-sm lg:text-lg text-gray-500 mb-4 lg:mb-6">æ®‹ã‚Š ${tour.remainingSeats}å¸­</p>
                        <div class="flex justify-between items-end">
                            <span class="text-2xl lg:text-3xl font-bold">Â¥${tour.price.toLocaleString()}</span>
                            ${isFull 
                                ? '<span class="bg-gray-300 text-gray-500 font-bold py-3 px-8 lg:py-4 lg:px-10 rounded-lg text-lg lg:text-xl">æº€å¸­</span>'
                                : `<button onclick="selectTour('${tour.id}', '${escapedTitle}', ${tour.price})" class="bg-primary hover:bg-primary-hover text-black font-bold py-3 px-8 lg:py-4 lg:px-10 rounded-lg text-lg lg:text-xl shadow-md border-b-4 border-yellow-500 active:border-b-0 active:translate-y-1 transition-colors">é¸æŠã™ã‚‹</button>`
                            }
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function goTo(screenId) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            window.scrollTo(0, 0);
        }

        async function selectDate(dateStr) {
            cache.date = dateStr;
            const [y, m, d] = dateStr.split('-');
            document.getElementById('view-date-title').innerText = `${parseInt(m)}æœˆ${parseInt(d)}æ—¥ã®ãƒ„ã‚¢ãƒ¼`;
            
            document.getElementById('tour-list').innerHTML = '<div class="text-center text-gray-400 py-8">èª­ã¿è¾¼ã¿ä¸­...</div>';
            goTo('screen-b02');
            await loadToursForDate(dateStr);
        }

        function selectTour(tourId, title, price) {
            cache.tourId = tourId;
            cache.tourTitle = title;
            cache.pricePerPerson = price;
            cache.passengers = parseInt(document.getElementById('input-passengers').value) || 1;
            setupPreferredSeatsUI();
            goTo('screen-b03');
            
            const saved = localStorage.getItem('user_profile_cache');
            if (saved) {
                showAutoFillDialog();
            }
        }

        function showAutoFillDialog() {
            const saved = localStorage.getItem('user_profile_cache');
            if (!saved) return;
            
            const data = JSON.parse(saved);
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4';
            modal.id = 'auto-fill-modal';
            modal.style.animation = 'fadeIn 0.2s ease-out';
            
            modal.innerHTML = `
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideUp {
                        from { opacity: 0; transform: translateY(20px) scale(0.95); }
                        to { opacity: 1; transform: translateY(0) scale(1); }
                    }
                    @keyframes slideOut {
                        from { opacity: 1; transform: translateY(0) scale(1); }
                        to { opacity: 0; transform: translateY(20px) scale(0.95); }
                    }
                    .popup-content {
                        animation: slideUp 0.3s ease-out;
                    }
                    .popup-closing {
                        animation: slideOut 0.2s ease-in forwards;
                    }
                </style>
                <div class="popup-content bg-white rounded-2xl max-w-sm w-full shadow-2xl overflow-hidden" onclick="event.stopPropagation()">
                    <div class="bg-blue-500 text-white p-4 text-center">
                        <div class="text-3xl mb-1">ğŸ“‹</div>
                        <h3 class="text-xl font-bold">å‰å›ã®æƒ…å ±ã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ</h3>
                    </div>
                    <div class="p-5">
                        <div class="bg-gray-50 p-4 rounded-xl space-y-3 mb-5 border border-gray-200">
                            <div class="flex items-start gap-3">
                                <span class="text-gray-400 text-lg">ğŸ‘¤</span>
                                <div class="flex-1">
                                    <p class="text-xs text-gray-500 mb-0.5">ãŠåå‰</p>
                                    <p class="font-bold text-base">${data.name || "---"}</p>
                                </div>
                            </div>
                            <div class="border-t border-gray-200"></div>
                            <div class="flex items-start gap-3">
                                <span class="text-gray-400 text-lg">ğŸ“</span>
                                <div class="flex-1">
                                    <p class="text-xs text-gray-500 mb-0.5">é›»è©±ç•ªå·</p>
                                    <p class="font-bold text-base">${data.phone || "---"}</p>
                                </div>
                            </div>
                            <div class="border-t border-gray-200"></div>
                            <div class="flex items-start gap-3">
                                <span class="text-gray-400 text-lg">ğŸ </span>
                                <div class="flex-1">
                                    <p class="text-xs text-gray-500 mb-0.5">ã”ä½æ‰€</p>
                                    <p class="font-bold text-sm leading-relaxed">${data.pref || ""}${data.city || ""}${data.street || ""}</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="closeAutoFillDialog()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3.5 rounded-xl text-lg transition-colors">ã„ã„ãˆ</button>
                            <button onclick="applyAutoFill()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3.5 rounded-xl text-lg transition-colors shadow-md">ã¯ã„</button>
                        </div>
                    </div>
                </div>
            `;
            
            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeAutoFillDialog();
                }
            };
            
            document.body.appendChild(modal);
            window.autoFillData = data;
        }
        
        function closeAutoFillDialog() {
            const modal = document.getElementById('auto-fill-modal');
            if (modal) {
                const content = modal.querySelector('.popup-content');
                if (content) {
                    content.classList.add('popup-closing');
                    setTimeout(() => modal.remove(), 200);
                } else {
                    modal.remove();
                }
            }
        }
        
        function applyAutoFill() {
            const data = window.autoFillData;
            document.getElementById('input-name').value = data.name || "";
            document.getElementById('input-phone').value = data.phone || "";
            document.getElementById('input-zip').value = data.zip || "";
            document.getElementById('input-pref').value = data.pref || "";
            document.getElementById('input-city').value = data.city || "";
            document.getElementById('input-street').value = data.street || "";
            closeAutoFillDialog();
        }

        function submitUserInfo() {
            cache.userInfo = {
                name: document.getElementById('input-name').value,
                phone: document.getElementById('input-phone').value,
                zip: document.getElementById('input-zip').value,
                pref: document.getElementById('input-pref').value,
                city: document.getElementById('input-city').value,
                street: document.getElementById('input-street').value
            };
            cache.passengers = parseInt(document.getElementById('input-passengers').value);

            const seatCheckbox = document.getElementById('preferred-seat-all');
            const allSeats = seatCheckbox && seatCheckbox.checked;
            cache.preferredSeats = Array(cache.passengers).fill(allSeats);

            const consent = document.getElementById('consent-next').checked;
            if (consent) {
                localStorage.setItem('user_profile_cache', JSON.stringify(cache.userInfo));
            }

            setupPickupScreen();
            goTo('screen-b04');
        }

        function setupPreferredSeatsUI() {
            const area = document.getElementById('preferred-seats-area');
            area.innerHTML = '';

            const container = document.createElement('div');
            container.className = "p-4 lg:p-6 bg-gray-50 rounded-lg border border-gray-200";

            const label = document.createElement('label');
            label.className = "flex items-center p-3 lg:p-4 bg-white border rounded-lg cursor-pointer hover:bg-gray-50 transition";
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = 'preferred-seat-all';
            checkbox.className = 'w-5 h-5 lg:w-7 lg:h-7 text-primary border-gray-300 rounded';
            
            const labelText = document.createElement('span');
            labelText.className = 'ml-3 lg:ml-4 text-lg lg:text-2xl font-bold';
            labelText.innerText = `å‰åˆ—åº§å¸­ã‚’å¸Œæœ›ã™ã‚‹ï¼ˆå…¨å“¡åˆ† +Â¥${(PREFERRED_SEAT_PRICE * cache.passengers).toLocaleString()}ï¼‰`;
            
            label.appendChild(checkbox);
            label.appendChild(labelText);
            container.appendChild(label);

            area.appendChild(container);
        }

        function setupPickupScreen() {
            document.getElementById('pickup-count-label').innerText = `å‚åŠ äººæ•°ï¼š${cache.passengers}å`;
            
            // å¸¸ã«ã€Œå…¨å“¡åŒã˜å ´æ‰€ã‹ã‚‰ä¹—è»Šã€ãƒ¢ãƒ¼ãƒ‰ã«å›ºå®š
            const modeSelector = document.getElementById('pickup-mode-selector');
            modeSelector.classList.add('hidden');
            modeSelector.classList.remove('flex');
            document.querySelector('input[name="pickup_mode"][value="same"]').checked = true;
            
            renderPickupDropdowns();
        }

        function renderPickupDropdowns() {
            const area = document.getElementById('pickup-dropdowns-area');
            area.innerHTML = '';
            
            // å¸¸ã«1ã¤ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®ã¿è¡¨ç¤ºï¼ˆå…¨å“¡åŒã˜å ´æ‰€ï¼‰
            const wrapper = document.createElement('div');
            
            const label = document.createElement('label');
            label.className = "block text-lg lg:text-2xl font-bold mb-2 lg:mb-3";
            label.innerText = "ä¹—è»Šå ´æ‰€ã‚’é¸æŠ";
            wrapper.appendChild(label);

            const select = document.createElement('select');
            select.className = "pickup-select w-full border-2 border-gray-300 p-3 lg:p-4 rounded-lg bg-white text-lg lg:text-2xl h-14 lg:h-16";
            
            PICKUP_OPTIONS.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.innerText = opt;
                select.appendChild(option);
            });

            wrapper.appendChild(select);
            area.appendChild(wrapper);
        }

        function submitPickups() {
            const selects = document.querySelectorAll('.pickup-select');
            cache.pickups = Array.from(selects).map(s => s.value);
            
            setupConfirmScreen();
            goTo('screen-b05');
        }

        function setupConfirmScreen() {
            document.getElementById('conf-tour').innerText = cache.tourTitle;
            document.getElementById('conf-date').innerText = cache.date;
            document.getElementById('conf-name').innerText = cache.userInfo.name + " æ§˜";
            document.getElementById('conf-passengers').innerText = cache.passengers + "å";
            
            const baseTour = cache.pricePerPerson * cache.passengers;
            const seatUpchargeCount = cache.preferredSeats.filter(s => s).length;
            const seatUpcharge = seatUpchargeCount * PREFERRED_SEAT_PRICE;
            const total = baseTour + seatUpcharge;
            
            document.getElementById('conf-base-price').innerText = "Â¥" + baseTour.toLocaleString();
            document.getElementById('conf-seat-price').innerText = "Â¥" + seatUpcharge.toLocaleString();
            document.getElementById('conf-total').innerText = "Â¥" + total.toLocaleString();

            const pickupContainer = document.getElementById('conf-pickups');
            pickupContainer.innerHTML = '';
            
            // å¸¸ã«å…¨å“¡åŒã˜ä¹—è»Šå ´æ‰€ã¨ã—ã¦è¡¨ç¤º
            pickupContainer.innerText = cache.pickups[0];

            const seatContainer = document.getElementById('conf-seats');
            seatContainer.innerHTML = '';
            const seatList = [];
            cache.preferredSeats.forEach((isSeat, idx) => {
                if (isSeat) {
                    seatList.push(`${idx+1}äººç›®`);
                }
            });
            if (seatList.length > 0) {
                seatContainer.innerText = seatList.join("ã€") + "ãŒå‰åˆ—åº§å¸­æŒ‡å®š";
            } else {
                seatContainer.innerText = "åº§å¸­æŒ‡å®šãªã—";
            }
        }

        function createCompletionScreen() {
            const existing = document.getElementById('screen-b06');
            if (existing) {
                existing.remove();
            }
            
            const screen = document.createElement('div');
            screen.id = 'screen-b06';
            screen.className = 'screen p-8 text-center flex flex-col justify-center min-h-[60vh]';
            screen.innerHTML = `
                <div class="text-6xl mb-6">âœ…</div>
                <h2 class="text-2xl font-bold mb-8">äºˆç´„ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ</h2>
                <div class="bg-blue-50 border-2 border-blue-100 p-6 rounded-xl text-left w-full mb-6 space-y-4">
                    <p class="text-base leading-relaxed">
                        å¼Šç¤¾ãŒç¢ºèªå¾Œã€LINEã«ã¦ã€äºˆç´„ç¢ºå®šé€šçŸ¥ã‚’ãŠé€ã‚Šã„ãŸã—ã¾ã™ã€‚æ‹…å½“è€…ã‹ã‚‰ã®é€£çµ¡ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚
                    </p>
                    <p class="text-base leading-relaxed">
                        2å–¶æ¥­æ—¥ï¼ˆåœŸæ—¥ç¥ä¼‘ï¼‰ã‚’çµŒéã—ã¦ã‚‚ã”é€£çµ¡ãŒãªã„å ´åˆã¯ã€ãŠç”³è¾¼ã¿ãŒå±Šã„ã¦ã„ãªã„å¯èƒ½æ€§ãŒã”ã–ã„ã¾ã™ã€‚ãã®éš›ã¯ãŠæ‰‹æ•°ã§ã™ãŒã”ä¸€å ±ãã ã•ã„ã€‚
                    </p>
                    <p class="text-base leading-relaxed">
                        ä¹—è»Šåœ°ã€Œå…­ä¹‹æœ¬ãƒ»ç±³åŸãƒ»å½¦æ ¹ã€ã¯ä»–ã®ãŠå®¢æ§˜ã‚’å«ã‚ã¦5åä»¥ä¸Šã®ãŠç”³è¾¼ã¿ãŒãªã„å ´åˆã€å¤‰æ›´ã‚’ãŠé¡˜ã„ã™ã‚‹å ´åˆãŒã”ã–ã„ã¾ã™ã€‚
                    </p>
                </div>
                <p class="text-xl font-bold text-gray-800">
                    ã“ã®ç”»é¢ã¯é–‰ã˜ã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ã€‚
                </p>
            `;
            
            document.querySelector('.max-w-md').appendChild(screen);
        }

        async function submitReservation() {
            if (cache.isSubmitting) {
                alert("é€ä¿¡ä¸­ã§ã™ã€‚ãŠå¾…ã¡ãã ã•ã„...");
                return;
            }

            cache.isSubmitting = true;
            const btn = document.getElementById('btn-confirm-reservation');
            btn.disabled = true;
            btn.innerText = "èª­ã¿è¾¼ã¿ä¸­â€¦";

            try {
                const payload = {
                    lineUserId: cache.lineUserId,
                    date: cache.date,
                    tourId: cache.tourId,
                    tourTitle: cache.tourTitle,
                    pricePerPerson: cache.pricePerPerson,
                    userInfo: cache.userInfo,
                    passengers: cache.passengers,
                    pickups: cache.pickups,
                    preferredSeats: cache.preferredSeats,
                    consentAutoFill: document.getElementById('consent-next').checked
                };

                const response = await fetch(`${BOOKING_API_BASE}/reservations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log("Reservation success:", data);
                    createCompletionScreen();
                    goTo('screen-b06');
                } else {
                    const error = await response.json();
                    alert("äºˆç´„ã‚¨ãƒ©ãƒ¼: " + (error.message || "äºˆç´„ã§ãã¾ã›ã‚“ã§ã—ãŸ"));
                }
            } catch (err) {
                console.error("API error:", err);
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            } finally {
                cache.isSubmitting = false;
                btn.disabled = false;
                btn.innerText = "äºˆç´„ã‚’ç¢ºå®šã™ã‚‹";
            }
        }
    </script>
</body>
</html>
