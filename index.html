<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºˆç´„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LIFF SDK -->
    <script src="https://liff.line.me/sdk/web/liff.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FACC15', /* é»„è‰² */
                        'primary-hover': '#EAB308',
                        text: '#000000',
                        bg: '#FFFFFF',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; }
        .screen { display: none; }
        .screen.active { display: block; }
        /* å…¥åŠ›è¦ç´ ã®æ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´ */
        input, select, textarea { font-size: 1.125rem; } 
    </style>
</head>
<body class="bg-gray-100 text-black antialiased">

    <div class="max-w-md mx-auto bg-white min-h-screen shadow-lg relative pb-10">
        
        <header class="bg-primary p-4 text-center font-bold text-xl shadow-sm sticky top-0 z-10">
            ãƒã‚¹ãƒ„ã‚¢ãƒ¼äºˆç´„
        </header>

        <div id="screen-b01" class="screen active p-4">
            <h2 class="text-xl font-bold text-center mb-6" id="calendar-month-title">--å¹´--æœˆ</h2>
            <div class="grid grid-cols-7 gap-2 text-center mb-2 font-bold text-gray-600">
                <div>æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div>åœŸ</div>
            </div>
            
            <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center">
                <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒAPIã‹ã‚‰å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                <div class="h-14 flex items-center justify-center text-gray-400">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            <p class="mt-6 text-sm text-gray-500 text-center">â€»ã‚°ãƒ¬ãƒ¼ã®æ—¥ä»˜ã¯é¸æŠã§ãã¾ã›ã‚“</p>
        </div>

        <div id="screen-b02" class="screen p-4">
            <button onclick="goTo('screen-b01')" class="text-blue-600 mb-4 text-lg font-bold">&lt; æ—¥ä»˜ã‚’å¤‰æ›´</button>
            <h2 class="text-xl font-bold mb-4" id="view-date-title">--æœˆ--æ—¥ã®ãƒ„ã‚¢ãƒ¼</h2>

            <div id="tour-list" class="space-y-6">
                <!-- ãƒ„ã‚¢ãƒ¼ä¸€è¦§ãŒAPIã‹ã‚‰å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                <div class="text-center text-gray-400 py-8">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>

        <div id="screen-b03" class="screen p-4">
            <button onclick="goTo('screen-b02')" class="text-blue-600 mb-4 text-lg font-bold">&lt; æˆ»ã‚‹</button>
            <h2 class="text-2xl font-bold mb-6">ãŠå®¢æ§˜æƒ…å ±ã®å…¥åŠ›</h2>

            <button type="button" onclick="showAutoFillDialog()" class="w-full bg-blue-100 text-blue-800 border-2 border-blue-200 font-bold py-3 rounded-lg mb-8 text-lg flex items-center justify-center gap-2">
                <span>ğŸ”„</span> å‰å›ã®æƒ…å ±ã‚’è‡ªå‹•å…¥åŠ›
            </button>

            <form id="booking-form" onsubmit="event.preventDefault(); submitUserInfo();">
                <div class="mb-6">
                    <label class="block text-lg font-bold mb-2">ãŠåå‰ <span class="text-red-500">*</span></label>
                    <input type="text" id="input-name" class="w-full border-2 border-gray-300 p-3 rounded-lg bg-gray-50" required>
                </div>

                <div class="mb-6">
                    <label class="block text-lg font-bold mb-2">é›»è©±ç•ªå· <span class="text-red-500">*</span></label>
                    <input type="tel" id="input-phone" class="w-full border-2 border-gray-300 p-3 rounded-lg bg-gray-50" required>
                </div>

                <div class="mb-6 p-4 bg-gray-50 rounded-xl border border-gray-200">
                    <p class="font-bold text-lg mb-4 border-b pb-2">ã”ä½æ‰€ <span class="text-red-500">*</span></p>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1 text-gray-600">éƒµä¾¿ç•ªå·</label>
                        <div class="flex gap-2">
                            <input type="text" id="input-zip" class="w-1/2 border-2 border-gray-300 p-3 rounded-lg bg-white">
                            <button type="button" class="w-1/2 bg-gray-200 text-black font-bold rounded-lg border-2 border-gray-300 text-sm">ä½æ‰€æ¤œç´¢</button>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1 text-gray-600">éƒ½é“åºœçœŒ</label>
                        <select id="input-pref" class="w-full border-2 border-gray-300 p-3 rounded-lg bg-white h-14">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="æ±äº¬éƒ½">æ±äº¬éƒ½</option>
                            <option value="ç¥å¥ˆå·çœŒ">ç¥å¥ˆå·çœŒ</option>
                            <option value="åŸ¼ç‰çœŒ">åŸ¼ç‰çœŒ</option>
                            </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1 text-gray-600">å¸‚åŒºç”ºæ‘</label>
                        <input type="text" id="input-city" class="w-full border-2 border-gray-300 p-3 rounded-lg bg-white">
                    </div>
                    <div class="mb-0">
                        <label class="block text-sm font-bold mb-1 text-gray-600">ç•ªåœ°ãƒ»å»ºç‰©å</label>
                        <input type="text" id="input-street" class="w-full border-2 border-gray-300 p-3 rounded-lg bg-white">
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-lg font-bold mb-2">å‚åŠ äººæ•°</label>
                    <select id="input-passengers" class="w-full border-2 border-gray-300 p-3 rounded-lg bg-white text-lg">
                        <option value="1">1å</option>
                        <option value="2">2å</option>
                        <option value="3">3å</option>
                        <option value="4">4å</option>
                    </select>
                </div>

                <div class="mb-6" id="preferred-seats-area">
                    <!-- å‰åˆ—åº§å¸­æŒ‡å®šãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒå‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
                </div>

                <div class="mb-8 flex items-center bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                    <input type="checkbox" id="consent-next" class="w-6 h-6 text-primary border-gray-300 rounded focus:ring-primary">
                    <label for="consent-next" class="ml-3 text-lg font-bold">æ¬¡å›ã‚‚ã“ã®æƒ…å ±ã‚’ä½¿ã†</label>
                </div>

                <button type="submit" class="w-full bg-primary hover:bg-primary-hover text-black font-bold py-4 rounded-xl text-xl shadow-md border-b-4 border-yellow-500 active:border-b-0 active:translate-y-1">
                    æ¬¡ã¸é€²ã‚€
                </button>
            </form>
        </div>

        <div id="screen-b04" class="screen p-4">
            <button onclick="goTo('screen-b03')" class="text-blue-600 mb-4 text-lg font-bold">&lt; æˆ»ã‚‹</button>
            <h2 class="text-2xl font-bold mb-6">ä¹—è»Šå ´æ‰€ã®é¸æŠ</h2>
            
            <p class="mb-4 font-bold text-lg" id="pickup-count-label">å‚åŠ äººæ•°ï¼š--å</p>

            <div id="pickup-mode-selector" class="hidden mb-6 flex-col gap-4">
                <label class="flex items-center p-4 border rounded-lg bg-white cursor-pointer has-[:checked]:border-primary has-[:checked]:bg-yellow-50 transition">
                    <input type="radio" name="pickup_mode" value="same" class="w-6 h-6" checked onchange="renderPickupDropdowns()">
                    <span class="ml-3 text-lg font-bold">å…¨å“¡åŒã˜å ´æ‰€ã‹ã‚‰ä¹—è»Š</span>
                </label>
                <label class="flex items-center p-4 border rounded-lg bg-white cursor-pointer has-[:checked]:border-primary has-[:checked]:bg-yellow-50 transition">
                    <input type="radio" name="pickup_mode" value="individual" class="w-6 h-6" onchange="renderPickupDropdowns()">
                    <span class="ml-3 text-lg font-bold">ä¸€äººãšã¤é¸ã¶</span>
                </label>
            </div>

            <div id="pickup-dropdowns-area" class="space-y-4 mb-8">
                </div>

            <button onclick="submitPickups()" class="w-full bg-primary hover:bg-primary-hover text-black font-bold py-4 rounded-xl text-xl shadow-md border-b-4 border-yellow-500 active:border-b-0 active:translate-y-1">
                ç¢ºèªç”»é¢ã¸
            </button>
        </div>

        <div id="screen-b05" class="screen p-4">
            <button onclick="goTo('screen-b04')" class="text-blue-600 mb-4 text-lg font-bold">&lt; æˆ»ã‚‹</button>
            <h2 class="text-2xl font-bold mb-6">äºˆç´„å†…å®¹ã®ç¢ºèª</h2>

            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-8">
                <div class="mb-4 pb-4 border-b border-gray-300">
                    <p class="text-gray-600 text-sm">ãƒ„ã‚¢ãƒ¼å</p>
                    <p class="text-xl font-bold" id="conf-tour">--</p>
                </div>
                <div class="mb-4 pb-4 border-b border-gray-300">
                    <p class="text-gray-600 text-sm">æ—¥ä»˜</p>
                    <p class="text-xl font-bold" id="conf-date">--</p>
                </div>
                <div class="mb-4 pb-4 border-b border-gray-300">
                    <p class="text-gray-600 text-sm">ä»£è¡¨è€…å</p>
                    <p class="text-xl font-bold" id="conf-name">-- æ§˜</p>
                </div>
                <div class="mb-4 pb-4 border-b border-gray-300">
                    <p class="text-gray-600 text-sm">äººæ•°</p>
                    <p class="text-xl font-bold" id="conf-passengers">--å</p>
                </div>
                <div class="mb-4 pb-4 border-b border-gray-300">
                    <p class="text-gray-600 text-sm">ä¹—è»Šå ´æ‰€</p>
                    <div id="conf-pickups" class="font-bold text-lg">
                        </div>
                </div>
                <div class="mb-4 pb-4 border-b border-gray-300">
                    <p class="text-gray-600 text-sm">å‰åˆ—åº§å¸­æŒ‡å®š</p>
                    <div id="conf-seats" class="font-bold text-lg">
                        </div>
                </div>

                <div class="mt-6 space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">åŸºæœ¬æ–™é‡‘</span>
                        <span class="font-bold" id="conf-base-price">Â¥0</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">åº§å¸­æŒ‡å®šæ–™</span>
                        <span class="font-bold" id="conf-seat-price">Â¥0</span>
                    </div>
                    <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-300">
                        <span class="text-lg font-bold">åˆè¨ˆé‡‘é¡</span>
                        <span class="text-3xl font-bold text-red-600" id="conf-total">Â¥0</span>
                    </div>
                </div>
            </div>

            <button id="btn-confirm-reservation" onclick="submitReservation()" class="w-full bg-primary hover:bg-primary-hover text-black font-bold py-4 rounded-xl text-2xl shadow-lg border-b-4 border-yellow-500 active:border-b-0 active:translate-y-1">
                äºˆç´„ã‚’ç¢ºå®šã™ã‚‹
            </button>
        </div>

        <div id="screen-b06" class="screen p-8 text-center flex flex-col justify-center min-h-[60vh]">
            <div class="text-6xl mb-6">âœ…</div>
            <h2 class="text-2xl font-bold mb-8">äºˆç´„ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ</h2>
            
            <div class="bg-red-50 border-2 border-red-100 p-6 rounded-xl text-left w-full mb-10">
                <p class="font-bold text-red-600 mb-2 text-lg">âš ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«ã¤ã„ã¦</p>
                <p class="text-lg font-medium">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯å…¬å¼LINEã‹ã‚‰ã”é€£çµ¡ãã ã•ã„ã€‚</p>
            </div>

            <p class="text-xl font-bold text-gray-800 leading-relaxed">
                ã“ã®ç”»é¢ã¯é–‰ã˜ã¦å¤§ä¸ˆå¤«ã§ã™<br>
                (LINEã«æˆ»ã£ã¦ãã ã•ã„)
            </p>
        </div>

    </div>

    <script>
        // ---------------------------------
        // è¨­å®šãƒ»å®šæ•°
        // ---------------------------------
        const BOOKING_API_BASE = "https://your-backend-booking-url/api/booking";
        const PREFERRED_SEAT_PRICE = 500;

        // ä¹—è»Šåœ°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆAPIã‹ã‚‰å‹•çš„ã«å–å¾—ã•ã‚Œã‚‹ï¼‰
        let PICKUP_OPTIONS = [];

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»ãƒ„ã‚¢ãƒ¼ãƒ‡ãƒ¼ã‚¿
        let calendarData = {}; // { "2026-03-15": ["tour_id_1", ...], ... }
        let toursData = {};    // { "tour_id_1": { title, date, price, capacity, description, imageUrl, status, remainingSeats }, ... }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ä¿æŒ
        const cache = {
            lineUserId: null,
            date: null,
            tourId: null,
            tourTitle: null,
            pricePerPerson: 0,
            userInfo: {},
            passengers: 1,
            pickups: [],
            preferredSeats: [],
            isSubmitting: false // äºŒé‡é€ä¿¡å¯¾ç­–
        };

        // ---------------------------------
        // LIFFåˆæœŸåŒ– & ãƒ‡ãƒ¼ã‚¿å–å¾—
        // ---------------------------------
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const liffId = "YOUR_LIFF_ID"; // ç’°å¢ƒã«åˆã‚ã›ã¦è¨­å®š
                await liff.init({ liffId });
                
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    cache.lineUserId = profile.userId;
                    console.log("LIFF initialized:", cache.lineUserId);
                    
                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥å–å¾—
                    await loadUserProfile();
                } else {
                    liff.login();
                }
            } catch (err) {
                console.error("LIFF init error:", err);
            }
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»ãƒ„ã‚¢ãƒ¼ãƒ»ä¹—è»Šåœ°ãƒ‡ãƒ¼ã‚¿å–å¾—
            await Promise.all([
                loadCalendarData(),
                loadPickupOptions()
            ]);
        });

        // ---------------------------------
        // API: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å–å¾—
        // ---------------------------------
        async function loadCalendarData() {
            try {
                const response = await fetch(`${BOOKING_API_BASE}/calendar`);
                if (response.ok) {
                    const data = await response.json();
                    // {dates: ["2026-03-15", ...]}
                    calendarData = {};
                    (data.dates || []).forEach(d => {
                        calendarData[d] = true;
                    });
                    renderCalendar();
                }
            } catch (err) {
                console.error("Failed to load calendar:", err);
            }
        }

        // ---------------------------------
        // API: ãƒ„ã‚¢ãƒ¼å–å¾—
        // ---------------------------------
        async function loadToursForDate(dateStr) {
            try {
                const response = await fetch(`${BOOKING_API_BASE}/tours?date=${dateStr}`);
                if (response.ok) {
                    const tours = await response.json();
                    toursData = {};
                    tours.forEach(t => {
                        toursData[t.id] = t;
                    });
                    renderTourList(dateStr);
                }
            } catch (err) {
                console.error("Failed to load tours:", err);
            }
        }

        // ---------------------------------
        // API: ä¹—è»Šåœ°å–å¾—
        // ---------------------------------
        async function loadPickupOptions() {
            try {
                const response = await fetch(`${BOOKING_API_BASE}/pickups`);
                if (response.ok) {
                    const pickups = await response.json();
                    PICKUP_OPTIONS = pickups.map(p => p.name);
                }
            } catch (err) {
                console.error("Failed to load pickups:", err);
                PICKUP_OPTIONS = ["æ–°å®¿é§… è¥¿å£", "æ±äº¬é§… ä¸¸ã®å†…åŒ—å£", "æ¨ªæµœé§… æ±å£"]; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            }
        }

        // ---------------------------------
        // API: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
        // ---------------------------------
        async function loadUserProfile() {
            if (!cache.lineUserId) return;
            
            try {
                const response = await fetch(`${BOOKING_API_BASE}/profile?lineUserId=${cache.lineUserId}`);
                if (response.ok) {
                    const profile = await response.json();
                    if (profile && Object.keys(profile).length > 0) {
                        // consentAutoFill=true ã®å ´åˆã®ã¿ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã•ã‚Œã‚‹
                        localStorage.setItem('user_profile_cache', JSON.stringify(profile));
                    }
                }
            } catch (err) {
                console.error("Failed to load profile:", err);
            }
        }

        // ---------------------------------
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»ï¼ˆå‹•çš„ï¼‰
        // ---------------------------------
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            // ä»Šæœˆã‚’åŸºæº–ã«è¡¨ç¤ºï¼ˆã¾ãŸã¯æœ€åˆã®åˆ©ç”¨å¯èƒ½æ—¥ä»˜ã‚’åŸºæº–ï¼‰
            let targetDate;
            const availableDates = Object.keys(calendarData).sort();
            if (availableDates.length > 0) {
                targetDate = new Date(availableDates[0] + 'T00:00:00');
            } else {
                targetDate = new Date();
            }
            
            const year = targetDate.getFullYear();
            const month = targetDate.getMonth();
            
            // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
            document.getElementById('calendar-month-title').innerText = `${year}å¹´ ${month + 1}æœˆ`;
            
            // æœˆåˆã®æ›œæ—¥ã¨æœˆæœ«ã®æ—¥ã‚’å–å¾—
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            
            // æœˆåˆã¾ã§ã®ç©ºç™½
            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'h-14';
                grid.appendChild(empty);
            }
            
            // å„æ—¥ä»˜ã‚’æç”»
            for (let d = 1; d <= lastDate; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const isAvailable = calendarData[dateStr];
                
                if (isAvailable) {
                    const btn = document.createElement('button');
                    btn.className = 'h-14 bg-white border-2 border-primary text-black font-bold flex items-center justify-center rounded shadow-sm hover:bg-yellow-50';
                    btn.innerText = d;
                    btn.onclick = () => selectDate(dateStr);
                    grid.appendChild(btn);
                } else {
                    const div = document.createElement('div');
                    div.className = 'h-14 bg-gray-100 text-gray-400 flex items-center justify-center rounded';
                    div.innerText = d;
                    grid.appendChild(div);
                }
            }
        }

        // ---------------------------------
        // ãƒ„ã‚¢ãƒ¼ä¸€è¦§æç”»ï¼ˆå‹•çš„ï¼‰
        // ---------------------------------
        function renderTourList(dateStr) {
            const container = document.getElementById('tour-list');
            container.innerHTML = '';
            
            const tours = Object.values(toursData);
            
            if (tours.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">ã“ã®æ—¥ã®ãƒ„ã‚¢ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            tours.forEach(tour => {
                const card = document.createElement('div');
                card.className = 'border rounded-xl overflow-hidden shadow-md';
                
                const isFull = tour.remainingSeats <= 0 || tour.status === 'full';
                const statusBadge = isFull 
                    ? '<span class="absolute top-2 right-2 bg-red-500 text-white px-2 py-1 rounded text-sm font-bold">æº€å¸­</span>' 
                    : '';
                
                card.innerHTML = `
                    <div class="relative">
                        ${tour.imageUrl 
                            ? `<img src="${tour.imageUrl}" alt="${tour.title}" class="w-full h-48 object-cover">` 
                            : '<div class="bg-gray-300 h-48 w-full flex items-center justify-center text-gray-500 font-bold">ãƒ„ã‚¢ãƒ¼ç”»åƒ</div>'}
                        ${statusBadge}
                    </div>
                    <div class="p-4">
                        <h3 class="text-xl font-bold mb-2">${tour.title}</h3>
                        <p class="text-gray-700 mb-2 text-lg">${tour.description || ''}</p>
                        <p class="text-sm text-gray-500 mb-4">æ®‹ã‚Š ${tour.remainingSeats}å¸­</p>
                        <div class="flex justify-between items-end">
                            <span class="text-2xl font-bold">Â¥${tour.price.toLocaleString()}</span>
                            ${isFull 
                                ? '<span class="bg-gray-300 text-gray-500 font-bold py-3 px-8 rounded-lg text-lg">æº€å¸­</span>'
                                : `<button onclick="selectTour('${tour.id}', '${tour.title}', ${tour.price})" class="bg-primary hover:bg-primary-hover text-black font-bold py-3 px-8 rounded-lg text-lg shadow-md border-b-4 border-yellow-500 active:border-b-0 active:translate-y-1">é¸æŠã™ã‚‹</button>`
                            }
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // ---------------------------------
        // ç”»é¢é·ç§»ãƒ»åˆæœŸè¨­å®š
        // ---------------------------------
        function goTo(screenId) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            window.scrollTo(0, 0);
        }

        // B-01 -> B-02
        async function selectDate(dateStr) {
            cache.date = dateStr;
            const [y, m, d] = dateStr.split('-');
            document.getElementById('view-date-title').innerText = `${parseInt(m)}æœˆ${parseInt(d)}æ—¥ã®ãƒ„ã‚¢ãƒ¼`;
            
            // ãƒ„ã‚¢ãƒ¼ä¸€è¦§ã‚’APIã‹ã‚‰å–å¾—
            document.getElementById('tour-list').innerHTML = '<div class="text-center text-gray-400 py-8">èª­ã¿è¾¼ã¿ä¸­...</div>';
            goTo('screen-b02');
            await loadToursForDate(dateStr);
        }

        // B-02 -> B-03
        function selectTour(tourId, title, price) {
            cache.tourId = tourId;
            cache.tourTitle = title;
            cache.pricePerPerson = price;
            cache.passengers = parseInt(document.getElementById('input-passengers').value) || 1;
            setupPreferredSeatsUI();
            goTo('screen-b03');
        }

        // ---------------------------------
        // B-03 å‡¦ç† (å…¥åŠ›ä¿å­˜)
        // ---------------------------------
        function showAutoFillDialog() {
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
            const saved = localStorage.getItem('user_profile_cache');
            if (!saved) {
                alert("ä¿å­˜ã•ã‚ŒãŸæƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“");
                return;
            }
            
            const data = JSON.parse(saved);
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ä½œæˆ
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.id = 'auto-fill-modal';
            
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-sm mx-4 shadow-2xl">
                    <h3 class="text-xl font-bold mb-4 text-center">å‰å›ã®æƒ…å ±</h3>
                    
                    <div class="bg-gray-50 p-4 rounded-lg mb-6 space-y-3 max-h-64 overflow-y-auto">
                        <div>
                            <p class="text-xs text-gray-600">ãŠåå‰</p>
                            <p class="font-bold text-lg">${data.name || "---"}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600">é›»è©±ç•ªå·</p>
                            <p class="font-bold text-lg">${data.phone || "---"}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600">ã”ä½æ‰€</p>
                            <p class="font-bold text-base">${data.pref || ""}${data.city || ""}${data.street || ""}</p>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="closeAutoFillDialog()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-black font-bold py-3 rounded-lg">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button onclick="applyAutoFill()" class="flex-1 bg-primary hover:bg-primary-hover text-black font-bold py-3 rounded-lg">
                            ã“ã®æƒ…å ±ã‚’å…¥åŠ›
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§ã¨ã—ã¦ä¿å­˜
            window.autoFillData = data;
        }
        
        function closeAutoFillDialog() {
            const modal = document.getElementById('auto-fill-modal');
            if (modal) modal.remove();
        }
        
        function applyAutoFill() {
            const data = window.autoFillData;
            document.getElementById('input-name').value = data.name || "";
            document.getElementById('input-phone').value = data.phone || "";
            document.getElementById('input-zip').value = data.zip || "";
            document.getElementById('input-pref').value = data.pref || "";
            document.getElementById('input-city').value = data.city || "";
            document.getElementById('input-street').value = data.street || "";
            closeAutoFillDialog();
        }

        function submitUserInfo() {
            // 1. å…¥åŠ›å€¤ã‚’ãƒ¡ãƒ¢ãƒª(ã‚­ãƒ£ãƒƒã‚·ãƒ¥)ã«ä¿å­˜
            cache.userInfo = {
                name: document.getElementById('input-name').value,
                phone: document.getElementById('input-phone').value,
                zip: document.getElementById('input-zip').value,
                pref: document.getElementById('input-pref').value,
                city: document.getElementById('input-city').value,
                street: document.getElementById('input-street').value
            };
            cache.passengers = parseInt(document.getElementById('input-passengers').value);

            // 2. å‰åˆ—åº§å¸­æŒ‡å®šæƒ…å ±ã‚’åé›†
            const seatCheckboxes = document.querySelectorAll('.preferred-seat-checkbox');
            cache.preferredSeats = Array.from(seatCheckboxes).map(cb => cb.checked);

            // 3. ã€Œæ¬¡å›ã‚‚ä½¿ã†ã€ãŒONãªã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ä¿å­˜
            const consent = document.getElementById('consent-next').checked;
            if (consent) {
                localStorage.setItem('user_profile_cache', JSON.stringify(cache.userInfo));
            }

            // 4. æ¬¡ã®ç”»é¢ã®æº–å‚™
            setupPickupScreen();
            goTo('screen-b04');
        }

        // ---------------------------------
        // B-03 åº§å¸­æŒ‡å®šUI
        // ---------------------------------
        function setupPreferredSeatsUI() {
            const area = document.getElementById('preferred-seats-area');
            area.innerHTML = ''; // ã‚¯ãƒªã‚¢

            // ã‚¿ã‚¤ãƒˆãƒ«
            const title = document.createElement('div');
            title.className = "text-lg font-bold mb-3";
            title.innerText = "å‰åˆ—åº§å¸­æŒ‡å®šï¼ˆ+500å††/äººï¼‰";
            area.appendChild(title);

            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—
            const container = document.createElement('div');
            container.className = "space-y-3 p-4 bg-gray-50 rounded-lg border border-gray-200";

            for (let i = 0; i < cache.passengers; i++) {
                const label = document.createElement('label');
                label.className = "flex items-center p-3 bg-white border rounded-lg cursor-pointer hover:bg-gray-50 transition";
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'preferred-seat-checkbox w-5 h-5 text-primary border-gray-300 rounded';
                checkbox.value = i;
                
                const labelText = document.createElement('span');
                labelText.className = 'ml-3 text-base font-medium';
                labelText.innerText = `${i + 1}äººç›®ï¼šå‰åˆ—åº§å¸­ã‚’å¸Œæœ›ã™ã‚‹`;
                
                label.appendChild(checkbox);
                label.appendChild(labelText);
                container.appendChild(label);
            }

            area.appendChild(container);
        }

        // ---------------------------------
        // B-04 å‡¦ç† (å‹•çš„ç”Ÿæˆ)
        // ---------------------------------
        function setupPickupScreen() {
            document.getElementById('pickup-count-label').innerText = `å‚åŠ äººæ•°ï¼š${cache.passengers}å`;
            
            const modeSelector = document.getElementById('pickup-mode-selector');
            if (cache.passengers >= 2) {
                modeSelector.classList.remove('hidden');
                modeSelector.classList.add('flex');
            } else {
                modeSelector.classList.add('hidden');
                modeSelector.classList.remove('flex');
                // å¼·åˆ¶çš„ã«ã€Œå…¨å“¡åŒã˜ã€ãƒ¢ãƒ¼ãƒ‰æ‰±ã„ã«
                document.querySelector('input[name="pickup_mode"][value="same"]').checked = true;
            }
            renderPickupDropdowns();
        }

        function renderPickupDropdowns() {
            const area = document.getElementById('pickup-dropdowns-area');
            area.innerHTML = ''; // ã‚¯ãƒªã‚¢
            
            const mode = document.querySelector('input[name="pickup_mode"]:checked').value;
            const count = (mode === 'same' || cache.passengers === 1) ? 1 : cache.passengers;

            for (let i = 0; i < count; i++) {
                const wrapper = document.createElement('div');
                
                // ãƒ©ãƒ™ãƒ« (ä¸€äººãšã¤ã®å ´åˆã®ã¿è¡¨ç¤º)
                if (mode === 'individual' && cache.passengers > 1) {
                    const label = document.createElement('label');
                    label.className = "block text-sm font-bold mb-1 text-gray-600";
                    label.innerText = `${i + 1}äººç›®ã®ä¹—è»Šå ´æ‰€`;
                    wrapper.appendChild(label);
                } else if (i === 0) {
                    const label = document.createElement('label');
                    label.className = "block text-lg font-bold mb-2";
                    label.innerText = "ä¹—è»Šå ´æ‰€ã‚’é¸æŠ";
                    wrapper.appendChild(label);
                }

                // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹
                const select = document.createElement('select');
                select.className = "pickup-select w-full border-2 border-gray-300 p-3 rounded-lg bg-white text-lg h-14";
                
                PICKUP_OPTIONS.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.innerText = opt;
                    select.appendChild(option);
                });

                wrapper.appendChild(select);
                area.appendChild(wrapper);
            }
        }

        function submitPickups() {
            // é¸æŠã•ã‚ŒãŸå€¤ã‚’åé›†
            const selects = document.querySelectorAll('.pickup-select');
            cache.pickups = Array.from(selects).map(s => s.value);
            
            setupConfirmScreen();
            goTo('screen-b05');
        }

        // ---------------------------------
        // B-05 å‡¦ç† (ç¢ºèªè¡¨ç¤º)
        // ---------------------------------
        function setupConfirmScreen() {
            // ä¿å­˜ã•ã‚ŒãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’DOMã«åæ˜ 
            document.getElementById('conf-tour').innerText = cache.tourTitle;
            document.getElementById('conf-date').innerText = cache.date;
            document.getElementById('conf-name').innerText = cache.userInfo.name + " æ§˜";
            document.getElementById('conf-passengers').innerText = cache.passengers + "å";
            
            // é‡‘é¡è¨ˆç®—
            const baseTour = cache.pricePerPerson * cache.passengers;
            const seatUpchargeCount = cache.preferredSeats.filter(s => s).length;
            const seatUpcharge = seatUpchargeCount * PREFERRED_SEAT_PRICE;
            const total = baseTour + seatUpcharge;
            
            document.getElementById('conf-base-price').innerText = "Â¥" + baseTour.toLocaleString();
            document.getElementById('conf-seat-price').innerText = "Â¥" + seatUpcharge.toLocaleString();
            document.getElementById('conf-total').innerText = "Â¥" + total.toLocaleString();

            // ä¹—è»Šåœ°è¡¨ç¤º
            const pickupContainer = document.getElementById('conf-pickups');
            pickupContainer.innerHTML = '';
            
            const mode = document.querySelector('input[name="pickup_mode"]:checked').value;
            if (mode === 'same' || cache.passengers === 1) {
                pickupContainer.innerText = cache.pickups[0];
            } else {
                const ul = document.createElement('ul');
                ul.className = "list-disc pl-5 text-base font-normal mt-2";
                cache.pickups.forEach((p, idx) => {
                    const li = document.createElement('li');
                    li.innerText = `${idx+1}äººç›®: ${p}`;
                    ul.appendChild(li);
                });
                pickupContainer.appendChild(ul);
            }

            // åº§å¸­æŒ‡å®šè¡¨ç¤º
            const seatContainer = document.getElementById('conf-seats');
            seatContainer.innerHTML = '';
            const seatList = [];
            cache.preferredSeats.forEach((isSeat, idx) => {
                if (isSeat) {
                    seatList.push(`${idx+1}äººç›®`);
                }
            });
            if (seatList.length > 0) {
                seatContainer.innerText = seatList.join("ã€") + "ãŒå‰åˆ—åº§å¸­æŒ‡å®š";
            } else {
                seatContainer.innerText = "åº§å¸­æŒ‡å®šãªã—";
            }
        }

        // ---------------------------------
        // B-06 äºˆç´„é€ä¿¡ï¼ˆäºŒé‡é€ä¿¡å¯¾ç­–ä»˜ãï¼‰
        // ---------------------------------
        async function submitReservation() {
            if (cache.isSubmitting) {
                alert("é€ä¿¡ä¸­ã§ã™ã€‚ãŠå¾…ã¡ãã ã•ã„...");
                return;
            }

            cache.isSubmitting = true;
            const btn = document.getElementById('btn-confirm-reservation');
            btn.disabled = true;
            btn.innerText = "èª­ã¿è¾¼ã¿ä¸­â€¦";

            try {
                const payload = {
                    lineUserId: cache.lineUserId,
                    date: cache.date,
                    tourId: cache.tourId,
                    tourTitle: cache.tourTitle,
                    pricePerPerson: cache.pricePerPerson,
                    userInfo: cache.userInfo,
                    passengers: cache.passengers,
                    pickups: cache.pickups,
                    preferredSeats: cache.preferredSeats,
                    consentAutoFill: document.getElementById('consent-next').checked
                };

                // APIå‘¼ã³å‡ºã— (æœ¬ç•ªç’°å¢ƒ)
                const response = await fetch(`${BOOKING_API_BASE}/reservations`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log("Reservation success:", data);
                    goTo('screen-b06');
                } else {
                    const error = await response.json();
                    alert("äºˆç´„ã‚¨ãƒ©ãƒ¼: " + (error.message || "äºˆç´„ã§ãã¾ã›ã‚“ã§ã—ãŸ"));
                }
            } catch (err) {
                console.error("API error:", err);
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            } finally {
                cache.isSubmitting = false;
                btn.disabled = false;
                btn.innerText = "äºˆç´„ã‚’ç¢ºå®šã™ã‚‹";
            }
        }
    </script>
</body>
</html>
