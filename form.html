<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºˆç´„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LIFF SDK -->
    <script src="https://liff.line.me/sdk/web/liff.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FACC15', /* é»„è‰² */
                        'primary-hover': '#EAB308',
                        text: '#000000',
                        bg: '#FFFFFF',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; }
        .screen { display: none; }
        .screen.active { display: block; }
        /* å…¥åŠ›è¦ç´ ã®æ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´ */
        input, select, textarea { font-size: 1.125rem; } 
    </style>
</head>
<body class="bg-gray-100 text-black antialiased">

    <div class="max-w-md mx-auto bg-white min-h-screen shadow-lg relative pb-10">
        
        <header class="bg-primary p-4 text-center font-bold text-xl shadow-sm sticky top-0 z-10">
            ãƒã‚¹ãƒ„ã‚¢ãƒ¼äºˆç´„
        </header>

        <div id="screen-b01" class="screen active p-4">
            <h2 class="text-xl font-bold text-center mb-6" id="calendar-month-title">2026å¹´ 1æœˆ</h2>
            <div class="grid grid-cols-7 gap-2 text-center mb-2 font-bold text-gray-600">
                <div>æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div>åœŸ</div>
            </div>
            
            <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center">
                <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
            </div>
            <p class="mt-6 text-sm text-gray-500 text-center">â€»ã‚°ãƒ¬ãƒ¼ã®æ—¥ä»˜ã¯é¸æŠã§ãã¾ã›ã‚“</p>
        </div>

        <div id="screen-b02" class="screen p-4">
            <button onclick="goTo('screen-b01')" class="text-blue-600 mb-4 text-lg font-bold">&lt; æ—¥ä»˜ã‚’å¤‰æ›´</button>
            <h2 class="text-xl font-bold mb-4" id="view-date-title">--æœˆ--æ—¥ã®ãƒ„ã‚¢ãƒ¼</h2>

            <div id="tour-list" class="space-y-6">
                <!-- ãƒ„ã‚¢ãƒ¼ä¸€è¦§ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
            </div>
        </div>

        <div id="screen-b03" class="screen p-4">
            <button onclick="goTo('screen-b02')" class="text-blue-600 mb-4 text-lg font-bold">&lt; æˆ»ã‚‹</button>
            <h2 class="text-2xl font-bold mb-6">ãŠå®¢æ§˜æƒ…å ±ã®å…¥åŠ›</h2>

            <!-- è‡ªå‹•å…¥åŠ›ãƒœã‚¿ãƒ³ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
            <button type="button" id="btn-auto-fill" onclick="showAutoFillDialog()" class="hidden w-full bg-blue-100 text-blue-800 border-2 border-blue-200 font-bold py-3 rounded-lg mb-8 text-lg flex items-center justify-center gap-2">
                <span>ğŸ”„</span> å‰å›ã®æƒ…å ±ã‚’è‡ªå‹•å…¥åŠ›
            </button>

            <form id="booking-form" onsubmit="event.preventDefault(); submitUserInfo();">
                <div class="mb-6">
                    <label class="block text-lg font-bold mb-2">ãŠåå‰ <span class="text-red-500">*</span></label>
                    <input type="text" id="input-name" class="w-full border-2 border-gray-300 p-3 rounded-lg bg-gray-50" required>
                </div>

                <div class="mb-6">
                    <label class="block text-lg font-bold mb-2">é›»è©±ç•ªå· <span class="text-red-500">*</span></label>
                    <input type="tel" id="input-phone" class="w-full border-2 border-gray-300 p-3 rounded-lg bg-gray-50" required>
                </div>

                <div class="mb-6 p-4 bg-gray-50 rounded-xl border border-gray-200">
                    <p class="font-bold text-lg mb-4 border-b pb-2">ã”ä½æ‰€ <span class="text-red-500">*</span></p>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1 text-gray-600">éƒµä¾¿ç•ªå·</label>
                        <div class="flex gap-2">
                            <input type="text" id="input-zip" class="w-1/2 border-2 border-gray-300 p-3 rounded-lg bg-white">
                            <button type="button" class="w-1/2 bg-gray-200 text-black font-bold rounded-lg border-2 border-gray-300 text-sm">ä½æ‰€æ¤œç´¢</button>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1 text-gray-600">éƒ½é“åºœçœŒ</label>
                        <select id="input-pref" class="w-full border-2 border-gray-300 p-3 rounded-lg bg-white h-14">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="åŒ—æµ·é“">åŒ—æµ·é“</option>
                            <option value="é’æ£®çœŒ">é’æ£®çœŒ</option>
                            <option value="å²©æ‰‹çœŒ">å²©æ‰‹çœŒ</option>
                            <option value="å®®åŸçœŒ">å®®åŸçœŒ</option>
                            <option value="ç§‹ç”°çœŒ">ç§‹ç”°çœŒ</option>
                            <option value="å±±å½¢çœŒ">å±±å½¢çœŒ</option>
                            <option value="ç¦å³¶çœŒ">ç¦å³¶çœŒ</option>
                            <option value="èŒ¨åŸçœŒ">èŒ¨åŸçœŒ</option>
                            <option value="æ ƒæœ¨çœŒ">æ ƒæœ¨çœŒ</option>
                            <option value="ç¾¤é¦¬çœŒ">ç¾¤é¦¬çœŒ</option>
                            <option value="åŸ¼ç‰çœŒ">åŸ¼ç‰çœŒ</option>
                            <option value="åƒè‘‰çœŒ">åƒè‘‰çœŒ</option>
                            <option value="æ±äº¬éƒ½">æ±äº¬éƒ½</option>
                            <option value="ç¥å¥ˆå·çœŒ">ç¥å¥ˆå·çœŒ</option>
                            <option value="æ–°æ½ŸçœŒ">æ–°æ½ŸçœŒ</option>
                            <option value="å¯Œå±±çœŒ">å¯Œå±±çœŒ</option>
                            <option value="çŸ³å·çœŒ">çŸ³å·çœŒ</option>
                            <option value="ç¦äº•çœŒ">ç¦äº•çœŒ</option>
                            <option value="å±±æ¢¨çœŒ">å±±æ¢¨çœŒ</option>
                            <option value="é•·é‡çœŒ">é•·é‡çœŒ</option>
                            <option value="å²é˜œçœŒ">å²é˜œçœŒ</option>
                            <option value="é™å²¡çœŒ">é™å²¡çœŒ</option>
                            <option value="æ„›çŸ¥çœŒ">æ„›çŸ¥çœŒ</option>
                            <option value="ä¸‰é‡çœŒ">ä¸‰é‡çœŒ</option>
                            <option value="æ»‹è³€çœŒ">æ»‹è³€çœŒ</option>
                            <option value="äº¬éƒ½åºœ">äº¬éƒ½åºœ</option>
                            <option value="å¤§é˜ªåºœ">å¤§é˜ªåºœ</option>
                            <option value="å…µåº«çœŒ">å…µåº«çœŒ</option>
                            <option value="å¥ˆè‰¯çœŒ">å¥ˆè‰¯çœŒ</option>
                            <option value="å’Œæ­Œå±±çœŒ">å’Œæ­Œå±±çœŒ</option>
                            <option value="é³¥å–çœŒ">é³¥å–çœŒ</option>
                            <option value="å³¶æ ¹çœŒ">å³¶æ ¹çœŒ</option>
                            <option value="å²¡å±±çœŒ">å²¡å±±çœŒ</option>
                            <option value="åºƒå³¶çœŒ">åºƒå³¶çœŒ</option>
                            <option value="å±±å£çœŒ">å±±å£çœŒ</option>
                            <option value="å¾³å³¶çœŒ">å¾³å³¶çœŒ</option>
                            <option value="é¦™å·çœŒ">é¦™å·çœŒ</option>
                            <option value="æ„›åª›çœŒ">æ„›åª›çœŒ</option>
                            <option value="é«˜çŸ¥çœŒ">é«˜çŸ¥çœŒ</option>
                            <option value="ç¦å²¡çœŒ">ç¦å²¡çœŒ</option>
                            <option value="ä½è³€çœŒ">ä½è³€çœŒ</option>
                            <option value="é•·å´çœŒ">é•·å´çœŒ</option>
                            <option value="ç†Šæœ¬çœŒ">ç†Šæœ¬çœŒ</option>
                            <option value="å¤§åˆ†çœŒ">å¤§åˆ†çœŒ</option>
                            <option value="å®®å´çœŒ">å®®å´çœŒ</option>
                            <option value="é¹¿å…å³¶çœŒ">é¹¿å…å³¶çœŒ</option>
                            <option value="æ²–ç¸„çœŒ">æ²–ç¸„çœŒ</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-bold mb-1 text-gray-600">å¸‚åŒºç”ºæ‘</label>
                        <input type="text" id="input-city" class="w-full border-2 border-gray-300 p-3 rounded-lg bg-white">
                    </div>
                    <div class="mb-0">
                        <label class="block text-sm font-bold mb-1 text-gray-600">ç•ªåœ°ãƒ»å»ºç‰©å</label>
                        <input type="text" id="input-street" class="w-full border-2 border-gray-300 p-3 rounded-lg bg-white">
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-lg font-bold mb-2">å‚åŠ äººæ•°</label>
                    <select id="input-passengers" class="w-full border-2 border-gray-300 p-3 rounded-lg bg-white text-lg" onchange="updatePreferredSeatsUI()">
                        <option value="1">1å</option>
                        <option value="2">2å</option>
                        <option value="3">3å</option>
                        <option value="4">4å</option>
                    </select>
                </div>

                <div class="mb-6" id="preferred-seats-area">
                    <!-- å‰åˆ—åº§å¸­æŒ‡å®šãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒå‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
                </div>

                <div class="mb-8 flex items-center bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                    <input type="checkbox" id="consent-next" class="w-6 h-6 text-primary border-gray-300 rounded focus:ring-primary">
                    <label for="consent-next" class="ml-3 text-lg font-bold">æ¬¡å›ã‚‚ã“ã®æƒ…å ±ã‚’ä½¿ã†</label>
                </div>

                <button type="submit" class="w-full bg-primary hover:bg-primary-hover text-black font-bold py-4 rounded-xl text-xl shadow-md border-b-4 border-yellow-500 active:border-b-0 active:translate-y-1">
                    æ¬¡ã¸é€²ã‚€
                </button>
            </form>
        </div>

        <div id="screen-b04" class="screen p-4">
            <button onclick="goTo('screen-b03')" class="text-blue-600 mb-4 text-lg font-bold">&lt; æˆ»ã‚‹</button>
            <h2 class="text-2xl font-bold mb-6">ä¹—è»Šå ´æ‰€ã®é¸æŠ</h2>
            
            <p class="mb-4 font-bold text-lg" id="pickup-count-label">å‚åŠ äººæ•°ï¼š--å</p>

            <div id="pickup-mode-selector" class="hidden mb-6 flex-col gap-4">
                <label class="flex items-center p-4 border rounded-lg bg-white cursor-pointer has-[:checked]:border-primary has-[:checked]:bg-yellow-50 transition">
                    <input type="radio" name="pickup_mode" value="same" class="w-6 h-6" checked onchange="renderPickupDropdowns()">
                    <span class="ml-3 text-lg font-bold">å…¨å“¡åŒã˜å ´æ‰€ã‹ã‚‰ä¹—è»Š</span>
                </label>
                <label class="flex items-center p-4 border rounded-lg bg-white cursor-pointer has-[:checked]:border-primary has-[:checked]:bg-yellow-50 transition">
                    <input type="radio" name="pickup_mode" value="individual" class="w-6 h-6" onchange="renderPickupDropdowns()">
                    <span class="ml-3 text-lg font-bold">ä¸€äººãšã¤é¸ã¶</span>
                </label>
            </div>

            <div id="pickup-dropdowns-area" class="space-y-4 mb-8">
            </div>

            <button onclick="submitPickups()" class="w-full bg-primary hover:bg-primary-hover text-black font-bold py-4 rounded-xl text-xl shadow-md border-b-4 border-yellow-500 active:border-b-0 active:translate-y-1">
                ç¢ºèªç”»é¢ã¸
            </button>
        </div>

        <div id="screen-b05" class="screen p-4">
            <button onclick="goTo('screen-b04')" class="text-blue-600 mb-4 text-lg font-bold">&lt; æˆ»ã‚‹</button>
            <h2 class="text-2xl font-bold mb-6">äºˆç´„å†…å®¹ã®ç¢ºèª</h2>

            <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-8">
                <div class="mb-4 pb-4 border-b border-gray-300">
                    <p class="text-gray-600 text-sm">ãƒ„ã‚¢ãƒ¼å</p>
                    <p class="text-xl font-bold" id="conf-tour">--</p>
                </div>
                <div class="mb-4 pb-4 border-b border-gray-300">
                    <p class="text-gray-600 text-sm">æ—¥ä»˜</p>
                    <p class="text-xl font-bold" id="conf-date">--</p>
                </div>
                <div class="mb-4 pb-4 border-b border-gray-300">
                    <p class="text-gray-600 text-sm">ä»£è¡¨è€…å</p>
                    <p class="text-xl font-bold" id="conf-name">-- æ§˜</p>
                </div>
                <div class="mb-4 pb-4 border-b border-gray-300">
                    <p class="text-gray-600 text-sm">äººæ•°</p>
                    <p class="text-xl font-bold" id="conf-passengers">--å</p>
                </div>
                <div class="mb-4 pb-4 border-b border-gray-300">
                    <p class="text-gray-600 text-sm">ä¹—è»Šå ´æ‰€</p>
                    <div id="conf-pickups" class="font-bold text-lg">
                    </div>
                </div>
                <div class="mb-4 pb-4 border-b border-gray-300">
                    <p class="text-gray-600 text-sm">å‰åˆ—åº§å¸­æŒ‡å®š</p>
                    <div id="conf-seats" class="font-bold text-lg">
                    </div>
                </div>

                <div class="mt-6 space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">åŸºæœ¬æ–™é‡‘</span>
                        <span class="font-bold" id="conf-base-price">Â¥0</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">åº§å¸­æŒ‡å®šæ–™</span>
                        <span class="font-bold" id="conf-seat-price">Â¥0</span>
                    </div>
                    <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-300">
                        <span class="text-lg font-bold">åˆè¨ˆé‡‘é¡</span>
                        <span class="text-3xl font-bold text-red-600" id="conf-total">Â¥0</span>
                    </div>
                </div>
            </div>

            <button id="btn-confirm-reservation" onclick="submitReservation()" class="w-full bg-primary hover:bg-primary-hover text-black font-bold py-4 rounded-xl text-2xl shadow-lg border-b-4 border-yellow-500 active:border-b-0 active:translate-y-1">
                äºˆç´„ã‚’ç¢ºå®šã™ã‚‹
            </button>
        </div>

        <div id="screen-b06" class="screen p-8 text-center flex flex-col justify-center min-h-[60vh]">
            <div class="text-6xl mb-6">âœ…</div>
            <h2 class="text-2xl font-bold mb-8">äºˆç´„ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ</h2>
            
            <div class="bg-red-50 border-2 border-red-100 p-6 rounded-xl text-left w-full mb-10">
                <p class="font-bold text-red-600 mb-2 text-lg">âš ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«ã¤ã„ã¦</p>
                <p class="text-lg font-medium">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯å…¬å¼LINEã‹ã‚‰ã”é€£çµ¡ãã ã•ã„ã€‚</p>
            </div>

            <p class="text-xl font-bold text-gray-800 leading-relaxed">
                ã“ã®ç”»é¢ã¯é–‰ã˜ã¦å¤§ä¸ˆå¤«ã§ã™<br>
                (LINEã«æˆ»ã£ã¦ãã ã•ã„)
            </p>
        </div>

    </div>

    <script>
        // ---------------------------------
        // è¨­å®šãƒ»å®šæ•°ï¼ˆé™çš„ãƒ‡ãƒ¼ã‚¿ï¼‰
        // ---------------------------------
        const PREFERRED_SEAT_PRICE = 500;

        // ä¹—è»Šåœ°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆé™çš„ãƒ‡ãƒ¼ã‚¿ï¼‰
        const PICKUP_OPTIONS = [
            "æ–°å®¿é§… è¥¿å£",
            "æ±äº¬é§… ä¸¸ã®å†…åŒ—å£",
            "æ¨ªæµœé§… æ±å£",
            "å¤§å®®é§… è¥¿å£"
        ];

        // ãƒ„ã‚¢ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆé™çš„ãƒ‡ãƒ¼ã‚¿ï¼‰
        const TOURS_DATA = {
            "tour-001": {
                id: "tour-001",
                title: "æ˜¥ã®ä¹å·ãƒ»æ¸©æ³‰ã‚ãã‚Š",
                description: "å¤§åˆ†ãƒ»ç†Šæœ¬ã®åæ¹¯ã‚’å·¡ã‚‹æ—…ã€‚",
                price: 12000,
                capacity: 40,
                remainingSeats: 15,
                imageUrl: "",
                status: "open",
                dates: ["2026-01-20", "2026-01-25", "2026-02-01"]
            },
            "tour-002": {
                id: "tour-002",
                title: "åŒ—æµ·é“ãƒ»é›ªã¾ã¤ã‚Šæº€å–«ãƒ„ã‚¢ãƒ¼",
                description: "æœ­å¹Œé›ªã¾ã¤ã‚Šã¨å°æ¨½é‹æ²³ã‚’å·¡ã‚‹3æ—¥é–“ã€‚",
                price: 35000,
                capacity: 30,
                remainingSeats: 8,
                imageUrl: "",
                status: "open",
                dates: ["2026-01-25", "2026-02-05"]
            },
            "tour-003": {
                id: "tour-003",
                title: "äº¬éƒ½ãƒ»å†¬ã®å¤éƒ½æ•£ç­–",
                description: "é‡‘é–£å¯ºãƒ»æ¸…æ°´å¯ºãªã©åæ‰€ã‚’å·¡ã‚‹æ—¥å¸°ã‚Šãƒ„ã‚¢ãƒ¼ã€‚",
                price: 8500,
                capacity: 45,
                remainingSeats: 0,
                imageUrl: "",
                status: "full",
                dates: ["2026-01-20"]
            }
        };

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆ©ç”¨å¯èƒ½æ—¥ï¼ˆé™çš„ãƒ‡ãƒ¼ã‚¿ï¼‰
        const AVAILABLE_DATES = ["2026-01-20", "2026-01-25", "2026-02-01", "2026-02-05"];

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ä¿æŒ
        const cache = {
            lineUserId: null,
            date: null,
            tourId: null,
            tourTitle: null,
            pricePerPerson: 0,
            userInfo: {},
            passengers: 1,
            pickups: [],
            preferredSeats: [],
            isSubmitting: false
        };

        // ---------------------------------
        // åˆæœŸåŒ–
        // ---------------------------------
        document.addEventListener('DOMContentLoaded', async () => {
            // LIFFåˆæœŸåŒ–ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            try {
                const liffId = "YOUR_LIFF_ID";
                await liff.init({ liffId });
                
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    cache.lineUserId = profile.userId;
                    console.log("LIFF initialized:", cache.lineUserId);
                }
            } catch (err) {
                console.log("LIFF init skipped (static mode):", err.message);
            }
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
            renderCalendar();
            
            // åº§å¸­æŒ‡å®šUIåˆæœŸåŒ–
            setupPreferredSeatsUI();
            
            // è‡ªå‹•å…¥åŠ›ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’ãƒã‚§ãƒƒã‚¯
            checkAutoFillCache();
        });

        // ---------------------------------
        // è‡ªå‹•å…¥åŠ›ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
        // ---------------------------------
        function checkAutoFillCache() {
            const saved = localStorage.getItem('user_profile_cache');
            const btn = document.getElementById('btn-auto-fill');
            
            if (saved) {
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚‹å ´åˆï¼šãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                btn.classList.remove('hidden');
                btn.classList.add('flex');
            } else {
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„å ´åˆï¼šãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                btn.classList.add('hidden');
                btn.classList.remove('flex');
            }
        }

        // ---------------------------------
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»ï¼ˆé™çš„ï¼‰
        // ---------------------------------
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            // 2026å¹´1æœˆã‚’è¡¨ç¤º
            const year = 2026;
            const month = 0; // 0 = January
            
            document.getElementById('calendar-month-title').innerText = `${year}å¹´ ${month + 1}æœˆ`;
            
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            
            // æœˆåˆã¾ã§ã®ç©ºç™½
            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'h-14';
                grid.appendChild(empty);
            }
            
            // å„æ—¥ä»˜ã‚’æç”»
            for (let d = 1; d <= lastDate; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const isAvailable = AVAILABLE_DATES.includes(dateStr);
                
                if (isAvailable) {
                    const btn = document.createElement('button');
                    btn.className = 'h-14 bg-white border-2 border-primary text-black font-bold flex items-center justify-center rounded shadow-sm hover:bg-yellow-50';
                    btn.innerText = d;
                    btn.onclick = () => selectDate(dateStr);
                    grid.appendChild(btn);
                } else {
                    const div = document.createElement('div');
                    div.className = 'h-14 bg-gray-100 text-gray-400 flex items-center justify-center rounded';
                    div.innerText = d;
                    grid.appendChild(div);
                }
            }
        }

        // ---------------------------------
        // ãƒ„ã‚¢ãƒ¼ä¸€è¦§æç”»ï¼ˆé™çš„ï¼‰
        // ---------------------------------
        function renderTourList(dateStr) {
            const container = document.getElementById('tour-list');
            container.innerHTML = '';
            
            // è©²å½“æ—¥ã®ãƒ„ã‚¢ãƒ¼ã‚’ãƒ•ã‚£ãƒ«ã‚¿
            const tours = Object.values(TOURS_DATA).filter(t => t.dates.includes(dateStr));
            
            if (tours.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">ã“ã®æ—¥ã®ãƒ„ã‚¢ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            tours.forEach(tour => {
                const card = document.createElement('div');
                card.className = 'border rounded-xl overflow-hidden shadow-md';
                
                const isFull = tour.remainingSeats <= 0 || tour.status === 'full';
                const statusBadge = isFull 
                    ? '<span class="absolute top-2 right-2 bg-red-500 text-white px-2 py-1 rounded text-sm font-bold">æº€å¸­</span>' 
                    : '';
                
                const escapedTitle = tour.title.replace(/'/g, "\\'");
                
                card.innerHTML = `
                    <div class="relative">
                        ${tour.imageUrl 
                            ? `<img src="${tour.imageUrl}" alt="${tour.title}" class="w-full h-48 object-cover">` 
                            : '<div class="bg-gray-300 h-48 w-full flex items-center justify-center text-gray-500 font-bold">ãƒ„ã‚¢ãƒ¼ç”»åƒ</div>'}
                        ${statusBadge}
                    </div>
                    <div class="p-4">
                        <h3 class="text-xl font-bold mb-2">${tour.title}</h3>
                        <p class="text-gray-700 mb-2 text-lg">${tour.description || ''}</p>
                        <p class="text-sm text-gray-500 mb-4">æ®‹ã‚Š ${tour.remainingSeats}å¸­</p>
                        <div class="flex justify-between items-end">
                            <span class="text-2xl font-bold">Â¥${tour.price.toLocaleString()}</span>
                            ${isFull 
                                ? '<span class="bg-gray-300 text-gray-500 font-bold py-3 px-8 rounded-lg text-lg">æº€å¸­</span>'
                                : `<button onclick="selectTour('${tour.id}', '${escapedTitle}', ${tour.price})" class="bg-primary hover:bg-primary-hover text-black font-bold py-3 px-8 rounded-lg text-lg shadow-md border-b-4 border-yellow-500 active:border-b-0 active:translate-y-1">é¸æŠã™ã‚‹</button>`
                            }
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // ---------------------------------
        // ç”»é¢é·ç§»
        // ---------------------------------
        function goTo(screenId) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            window.scrollTo(0, 0);
            
            // B-03ç”»é¢ã«é·ç§»æ™‚ã€è‡ªå‹•å…¥åŠ›ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
            if (screenId === 'screen-b03') {
                checkAutoFillCache();
            }
        }

        // B-01 -> B-02
        function selectDate(dateStr) {
            cache.date = dateStr;
            const [y, m, d] = dateStr.split('-');
            document.getElementById('view-date-title').innerText = `${parseInt(m)}æœˆ${parseInt(d)}æ—¥ã®ãƒ„ã‚¢ãƒ¼`;
            
            renderTourList(dateStr);
            goTo('screen-b02');
        }

        // B-02 -> B-03
        function selectTour(tourId, title, price) {
            cache.tourId = tourId;
            cache.tourTitle = title;
            cache.pricePerPerson = price;
            cache.passengers = parseInt(document.getElementById('input-passengers').value) || 1;
            setupPreferredSeatsUI();
            goTo('screen-b03');
        }

        // ---------------------------------
        // B-03 è‡ªå‹•å…¥åŠ›ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å½¢å¼ï¼‰
        // ---------------------------------
        function showAutoFillDialog() {
            const saved = localStorage.getItem('user_profile_cache');
            
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
            if (!saved) {
                return;
            }
            
            const data = JSON.parse(saved);
            
            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆ
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4';
            modal.id = 'auto-fill-modal';
            modal.style.animation = 'fadeIn 0.2s ease-out';
            
            modal.innerHTML = `
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideUp {
                        from { opacity: 0; transform: translateY(20px) scale(0.95); }
                        to { opacity: 1; transform: translateY(0) scale(1); }
                    }
                    @keyframes slideOut {
                        from { opacity: 1; transform: translateY(0) scale(1); }
                        to { opacity: 0; transform: translateY(20px) scale(0.95); }
                    }
                    .popup-content {
                        animation: slideUp 0.3s ease-out;
                    }
                    .popup-closing {
                        animation: slideOut 0.2s ease-in forwards;
                    }
                </style>
                <div class="popup-content bg-white rounded-2xl max-w-sm w-full shadow-2xl overflow-hidden" onclick="event.stopPropagation()">
                    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                    <div class="bg-blue-500 text-white p-4 text-center">
                        <div class="text-3xl mb-1">ğŸ“‹</div>
                        <h3 class="text-xl font-bold">å‰å›ã®æƒ…å ±ã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ</h3>
                    </div>
                    
                    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
                    <div class="p-5">
                        <div class="bg-gray-50 p-4 rounded-xl space-y-3 mb-5 border border-gray-200">
                            <div class="flex items-start gap-3">
                                <span class="text-gray-400 text-lg">ğŸ‘¤</span>
                                <div class="flex-1">
                                    <p class="text-xs text-gray-500 mb-0.5">ãŠåå‰</p>
                                    <p class="font-bold text-base">${data.name || "---"}</p>
                                </div>
                            </div>
                            <div class="border-t border-gray-200"></div>
                            <div class="flex items-start gap-3">
                                <span class="text-gray-400 text-lg">ğŸ“</span>
                                <div class="flex-1">
                                    <p class="text-xs text-gray-500 mb-0.5">é›»è©±ç•ªå·</p>
                                    <p class="font-bold text-base">${data.phone || "---"}</p>
                                </div>
                            </div>
                            <div class="border-t border-gray-200"></div>
                            <div class="flex items-start gap-3">
                                <span class="text-gray-400 text-lg">ğŸ </span>
                                <div class="flex-1">
                                    <p class="text-xs text-gray-500 mb-0.5">ã”ä½æ‰€</p>
                                    <p class="font-bold text-sm leading-relaxed">${data.pref || ""}${data.city || ""}${data.street || ""}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ãƒœã‚¿ãƒ³ -->
                        <div class="flex gap-3">
                            <button onclick="closeAutoFillDialog()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3.5 rounded-xl text-lg transition-colors">
                                ã„ã„ãˆ
                            </button>
                            <button onclick="applyAutoFill()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3.5 rounded-xl text-lg transition-colors shadow-md">
                                ã¯ã„
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeAutoFillDialog();
                }
            };
            
            document.body.appendChild(modal);
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§ã¨ã—ã¦ä¿å­˜
            window.autoFillData = data;
        }
        
        function closeAutoFillDialog() {
            const modal = document.getElementById('auto-fill-modal');
            if (modal) {
                const content = modal.querySelector('.popup-content');
                if (content) {
                    content.classList.add('popup-closing');
                    setTimeout(() => modal.remove(), 200);
                } else {
                    modal.remove();
                }
            }
        }
        
        function applyAutoFill() {
            const data = window.autoFillData;
            document.getElementById('input-name').value = data.name || "";
            document.getElementById('input-phone').value = data.phone || "";
            document.getElementById('input-zip').value = data.zip || "";
            document.getElementById('input-pref').value = data.pref || "";
            document.getElementById('input-city').value = data.city || "";
            document.getElementById('input-street').value = data.street || "";
            closeAutoFillDialog();
        }

        function submitUserInfo() {
            cache.userInfo = {
                name: document.getElementById('input-name').value,
                phone: document.getElementById('input-phone').value,
                zip: document.getElementById('input-zip').value,
                pref: document.getElementById('input-pref').value,
                city: document.getElementById('input-city').value,
                street: document.getElementById('input-street').value
            };
            cache.passengers = parseInt(document.getElementById('input-passengers').value);

            const seatCheckboxes = document.querySelectorAll('.preferred-seat-checkbox');
            cache.preferredSeats = Array.from(seatCheckboxes).map(cb => cb.checked);

            const consent = document.getElementById('consent-next').checked;
            if (consent) {
                localStorage.setItem('user_profile_cache', JSON.stringify(cache.userInfo));
            }

            setupPickupScreen();
            goTo('screen-b04');
        }

        // ---------------------------------
        // B-03 åº§å¸­æŒ‡å®šUI
        // ---------------------------------
        function setupPreferredSeatsUI() {
            const area = document.getElementById('preferred-seats-area');
            area.innerHTML = '';
            
            const passengers = parseInt(document.getElementById('input-passengers').value) || 1;
            cache.passengers = passengers;

            const title = document.createElement('div');
            title.className = "text-lg font-bold mb-3";
            title.innerText = "å‰åˆ—åº§å¸­æŒ‡å®šï¼ˆ+500å††/äººï¼‰";
            area.appendChild(title);

            const container = document.createElement('div');
            container.className = "space-y-3 p-4 bg-gray-50 rounded-lg border border-gray-200";

            for (let i = 0; i < passengers; i++) {
                const label = document.createElement('label');
                label.className = "flex items-center p-3 bg-white border rounded-lg cursor-pointer hover:bg-gray-50 transition";
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'preferred-seat-checkbox w-5 h-5 text-primary border-gray-300 rounded';
                checkbox.value = i;
                
                const labelText = document.createElement('span');
                labelText.className = 'ml-3 text-base font-medium';
                labelText.innerText = `${i + 1}äººç›®ï¼šå‰åˆ—åº§å¸­ã‚’å¸Œæœ›ã™ã‚‹`;
                
                label.appendChild(checkbox);
                label.appendChild(labelText);
                container.appendChild(label);
            }

            area.appendChild(container);
        }
        
        function updatePreferredSeatsUI() {
            setupPreferredSeatsUI();
        }

        // ---------------------------------
        // B-04 å‡¦ç†
        // ---------------------------------
        function setupPickupScreen() {
            document.getElementById('pickup-count-label').innerText = `å‚åŠ äººæ•°ï¼š${cache.passengers}å`;
            
            const modeSelector = document.getElementById('pickup-mode-selector');
            if (cache.passengers >= 2) {
                modeSelector.classList.remove('hidden');
                modeSelector.classList.add('flex');
            } else {
                modeSelector.classList.add('hidden');
                modeSelector.classList.remove('flex');
                document.querySelector('input[name="pickup_mode"][value="same"]').checked = true;
            }
            renderPickupDropdowns();
        }

        function renderPickupDropdowns() {
            const area = document.getElementById('pickup-dropdowns-area');
            area.innerHTML = '';
            
            const mode = document.querySelector('input[name="pickup_mode"]:checked').value;
            const count = (mode === 'same' || cache.passengers === 1) ? 1 : cache.passengers;

            for (let i = 0; i < count; i++) {
                const wrapper = document.createElement('div');
                
                if (mode === 'individual' && cache.passengers > 1) {
                    const label = document.createElement('label');
                    label.className = "block text-sm font-bold mb-1 text-gray-600";
                    label.innerText = `${i + 1}äººç›®ã®ä¹—è»Šå ´æ‰€`;
                    wrapper.appendChild(label);
                } else if (i === 0) {
                    const label = document.createElement('label');
                    label.className = "block text-lg font-bold mb-2";
                    label.innerText = "ä¹—è»Šå ´æ‰€ã‚’é¸æŠ";
                    wrapper.appendChild(label);
                }

                const select = document.createElement('select');
                select.className = "pickup-select w-full border-2 border-gray-300 p-3 rounded-lg bg-white text-lg h-14";
                
                PICKUP_OPTIONS.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.innerText = opt;
                    select.appendChild(option);
                });

                wrapper.appendChild(select);
                area.appendChild(wrapper);
            }
        }

        function submitPickups() {
            const selects = document.querySelectorAll('.pickup-select');
            cache.pickups = Array.from(selects).map(s => s.value);
            
            setupConfirmScreen();
            goTo('screen-b05');
        }

        // ---------------------------------
        // B-05 å‡¦ç†
        // ---------------------------------
        function setupConfirmScreen() {
            document.getElementById('conf-tour').innerText = cache.tourTitle;
            document.getElementById('conf-date').innerText = cache.date;
            document.getElementById('conf-name').innerText = cache.userInfo.name + " æ§˜";
            document.getElementById('conf-passengers').innerText = cache.passengers + "å";
            
            const baseTour = cache.pricePerPerson * cache.passengers;
            const seatUpchargeCount = cache.preferredSeats.filter(s => s).length;
            const seatUpcharge = seatUpchargeCount * PREFERRED_SEAT_PRICE;
            const total = baseTour + seatUpcharge;
            
            document.getElementById('conf-base-price').innerText = "Â¥" + baseTour.toLocaleString();
            document.getElementById('conf-seat-price').innerText = "Â¥" + seatUpcharge.toLocaleString();
            document.getElementById('conf-total').innerText = "Â¥" + total.toLocaleString();

            const pickupContainer = document.getElementById('conf-pickups');
            pickupContainer.innerHTML = '';
            
            const mode = document.querySelector('input[name="pickup_mode"]:checked').value;
            if (mode === 'same' || cache.passengers === 1) {
                pickupContainer.innerText = cache.pickups[0];
            } else {
                const ul = document.createElement('ul');
                ul.className = "list-disc pl-5 text-base font-normal mt-2";
                cache.pickups.forEach((p, idx) => {
                    const li = document.createElement('li');
                    li.innerText = `${idx+1}äººç›®: ${p}`;
                    ul.appendChild(li);
                });
                pickupContainer.appendChild(ul);
            }

            const seatContainer = document.getElementById('conf-seats');
            seatContainer.innerHTML = '';
            const seatList = [];
            cache.preferredSeats.forEach((isSeat, idx) => {
                if (isSeat) {
                    seatList.push(`${idx+1}äººç›®`);
                }
            });
            if (seatList.length > 0) {
                seatContainer.innerText = seatList.join("ã€") + "ãŒå‰åˆ—åº§å¸­æŒ‡å®š";
            } else {
                seatContainer.innerText = "åº§å¸­æŒ‡å®šãªã—";
            }
        }

        // ---------------------------------
        // B-06 äºˆç´„é€ä¿¡ï¼ˆé™çš„ãƒ‡ãƒ¢ï¼‰
        // ---------------------------------
        async function submitReservation() {
            if (cache.isSubmitting) {
                alert("é€ä¿¡ä¸­ã§ã™ã€‚ãŠå¾…ã¡ãã ã•ã„...");
                return;
            }

            cache.isSubmitting = true;
            const btn = document.getElementById('btn-confirm-reservation');
            btn.disabled = true;
            btn.innerText = "èª­ã¿è¾¼ã¿ä¸­â€¦";

            // é™çš„ãƒ‡ãƒ¢ï¼š1ç§’å¾…ã£ã¦ã‹ã‚‰å®Œäº†ç”»é¢ã¸
            await new Promise(resolve => setTimeout(resolve, 1000));

            console.log("Reservation data:", {
                lineUserId: cache.lineUserId,
                date: cache.date,
                tourId: cache.tourId,
                tourTitle: cache.tourTitle,
                pricePerPerson: cache.pricePerPerson,
                userInfo: cache.userInfo,
                passengers: cache.passengers,
                pickups: cache.pickups,
                preferredSeats: cache.preferredSeats,
                consentAutoFill: document.getElementById('consent-next').checked
            });

            goTo('screen-b06');
            
            cache.isSubmitting = false;
            btn.disabled = false;
            btn.innerText = "äºˆç´„ã‚’ç¢ºå®šã™ã‚‹";
        }
    </script>
</body>
</html>
